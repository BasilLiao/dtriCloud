<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<title>DTR CLOUD(å®šèª¼é›²å¹³å°)</title>
<script src="./thirdparty/js/jquery-3.7.0.min.js"></script>
<script src="./thirdparty/js/jquery-ui-1.13.2.min.js"></script>
<script src="./thirdparty/js/jquery-qrcode.min.js"></script>
<script src="./thirdparty/js/JsBarcode.all.min.js"></script>
<script src="./thirdparty/js/bootstrap-5.2.3.min.js"></script>
<script src="./thirdparty/js/bootstrap-datetimepicker.min.js"></script>



<script src="./thirdparty/js/table-exceljs.js"></script>
<script src="./thirdparty/js/table-2excel.core.js"></script>
<script src="./thirdparty/js/xlsx-0.17.5.min.js"></script>
<script src="./thirdparty/js/FileSaver-2.0.5.min.js"></script>

<link rel="stylesheet" href="./thirdparty/css/jquery-ui-1.13.2.min.css" />
<link rel="stylesheet" href="./thirdparty/css/bootstrap-5.2.3.min.css" />
<link rel="stylesheet"
	href="./thirdparty/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet"
	href="./thirdparty/bootstrap-icons-1.10.5/font/bootstrap-icons.min.css">


<link rel="icon" type="img/svg" href="./img/icon.png">
<style type="text/css">
body {
	background-color: #f8f9fc;
}

/*æ™‚é–“æ ¼å¼ä¸‹ç§»*/
.datetimepicker {
	margin-top: 25px;
}
</style>
</head>

<body id="main">
	<!-- é–‹é ­(header) -->
	<div id="header_page"></div>
	<!-- é¸å–®(nav) -->
	<div id="nav_page"></div>
	<!-- è²éŸ³(nav_sound) -->
	<div id="nav_index"></div>
	<!-- è®€å–ä¸­(nav_loading) -->
	<div id="loading_page"></div>
	<!-- ç™»å‡ºä¸­(nav_logout) -->
	<div id="logout_page"></div>
	<!-- æœ¬é«”(body) -->
	<div id="body_page"></div>
	<!-- åº•éƒ¨(footer) -->
	<div id="footer_page"></div>

</body>
<script type="text/javascript" th:inline="javascript">
	//====Step1.åˆå§‹åŒ–====
	//å‚³é€é…ç½®
	let ajaxSendQueue = [];               // å‚³é€æ’ç¨‹ä½‡åˆ—
	let ajaxSendIsSending = false;        // æ˜¯å¦æ­£åœ¨å‚³é€
	const ajaxSendDelay = 1500;            // å‚³é€é–“éš”æ™‚é–“ (ms)
	let ajaxSendLastTime = 0;             // æœ€è¿‘ä¸€æ¬¡å‚³é€æ™‚é–“æˆ³
	let ajaxSendLastReqKey = "";          // æœ€è¿‘ä¸€æ¬¡å‚³é€çš„è­˜åˆ¥ç¢¼
	//
	var main = {};
	//main.web_html .=å„é¡-ç¶²é é¢ä½ç½®(éœ€è¨»å†Š-é ­/èº«/åº•/è¦½/è­¦/è®€å–ä¸­/å‡º)
	var header_index = {}, body_index = {}, footer_index = {}, nav_index = {}, nav_alert = {}, loading = {}, logout = {};
	//main.web_body .=å„é¡-èº«é«”æ¨¡æ¿(éœ€è¨»å†Š-å®¶/æŸ¥/ä¿®/å°/å ±/æ¯”/ç‰¹)
	var home = {}, search = {}, modify = {}, print = {}, report = {}, compare = {}, other = {};
	//è³‡æ–™-å€‹äººåŸºæœ¬è³‡è¨Š(æš«å­˜-å/æ…‹/è·/ç™»æ™‚)
	main.web_user = {name: "", status: "", position: "", login_time: ""};
	//è³‡æ–™-å‚³é€(ä½ç½®/è«‹æ±‚é¡å‹[POST/GET/PUT/DELETE]/è³‡æ–™å…§å®¹)
	main.req_data = {url: "index.basil", type: "POST", data: {}};
	//è³‡æ–™-æ¥æ”¶(å›å‚³å‘¼å«å°è±¡,è³‡æ–™å…§å®¹,æŒ‡å®šæ¨¡æ¿,å›é¥‹è¨Šæ¯(é¡è‰²,è³‡è¨Š))
	main.resq_data = {callBackFunction: "", callBackValue: "", data: {}, htmlBody: "", message: {color: "", message: ""}};
	//æŸ¥è©¢è«‹æ±‚-åˆ†é è¨­å®š(è«‹æ±‚ç¸½ç­†æ•¸/ç¬¬å¹¾æ‰¹æ¬¡)
	main.search_req_page = {total: 1000, batch: 0};
	//æŸ¥è©¢é¡¯ç¤º-åˆ†é è¨­å®š(ç›®å‰æ‰€åœ¨åˆ†é /æ¯åˆ†é æ•¸é‡/æ­¤æ¬¡å¾—åˆ°è³‡æ–™ç¸½ç­†æ•¸/æœ¬æ¬¡æ‰¹æ¬¡)
	main.search_show_page = {index: 1, size: 100, total: 1000, batch: 0}
	//============ä»¥é˜²é›¢é–‹å¤ªä¹…============
	let hiddenTime = new Date().getTime();
	$(document).off('visibilitychange');
	$(document).on('visibilitychange', function () {
		if (document.visibilityState === 'visible') {
			// ä½¿ç”¨è€…åˆ‡æ›å›æœ¬é é¢æ™‚è§¸ç™¼çš„äº‹ä»¶
			// è¨ˆç®—é›¢é–‹é é¢çš„æ™‚é–“å·®
			let visibleTime = new Date().getTime();
			let timeDifference = visibleTime - hiddenTime;
			console.log('Main-æ­¡è¿å›ä¾†ï¼' + timeDifference);
			if (timeDifference > 1800000) { // 30 åˆ†é˜ = 1800,000 æ¯«ç§’
				// é›¢é–‹è¶…é 30 åˆ†é˜æ™‚åˆ·æ–°ç¶²é 
				var mainAlertM = nav_alert.methods;
				mainAlertM.alertshow("warning", "[266]You have been inactive for too long and will be redirected to the 'home' page. [Reload]!!");
				$("#loading").removeClass("d-none");
				setTimeout(function () {
					location.reload();
				}, 2000);
			}
		} else {
			// ä½¿ç”¨è€…é›¢é–‹æœ¬é é¢æ™‚è§¸ç™¼çš„äº‹ä»¶ï¼ˆå¯é¸ï¼‰
			console.log('Main-ä½ é›¢é–‹äº†é é¢ã€‚');
		}
	});
	// ç›£è½ä»»ä½•ç‰©ä»¶çš„é»æ“Šäº‹ä»¶
	$(document).on('click');
	$(document).on('click', function (event) {
		//é‡æ–°æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆ
		let visibleTime = new Date().getTime();
		let timeDifference = visibleTime - hiddenTime;
		//console.log('Main-æª¢æŸ¥æ™‚æ•ˆï¼' + timeDifference);
		if (timeDifference > 1800000) { // 30 åˆ†é˜ = 1800,000 æ¯«ç§’
			// é›¢é–‹è¶…é 15 åˆ†é˜æ™‚åˆ·æ–°ç¶²é 
			var mainAlertM = nav_alert.methods;
			mainAlertM.alertshow("warning", "[266]You have been inactive for too long and will be redirected to the 'home' page. [Reload]!!");
			$("#loading").removeClass("d-none");
			setTimeout(function () {
				location.reload();
			}, 2000);
		}
	});
	//============å…±ç”¨-æ–¹æ³•æ¸…å–®============
	main.methods = {
		ajaxSend(req_data, loading) {
			// === Step 1. ç”¢ç”Ÿå”¯ä¸€è«‹æ±‚è­˜åˆ¥ç¢¼ (URL + TYPE + Dataæ‘˜è¦) ===
			const reqKey = `${req_data.url}_${req_data.type}_${JSON.stringify(req_data.data)}`;
			
			// === Step 2. é˜²æ­¢ 0.5 ç§’å…§é‡è¤‡å‚³é€ç›¸åŒè«‹æ±‚ ===
			const now = new Date().getTime();
			if (reqKey === ajaxSendLastReqKey && (now - ajaxSendLastTime) < ajaxSendDelay) {
			  console.warn("âš ï¸ [ajaxSend] é‡è¤‡é»æ“Šè¢«å¿½ç•¥ ("+ajaxSendDelay+" è±ªç§’å†·å»ä¸­)", req_data.url);
			  return; // ç›´æ¥è·³å‡ºï¼Œä¸é€²å…¥ queue
			}
			ajaxSendLastReqKey = reqKey;
			ajaxSendLastTime = now;
			
			// === Step 3. å°‡è«‹æ±‚åŠ å…¥ä½‡åˆ— ===
			ajaxSendQueue.push({ req_data, loading });
			main.methods.runNextAjaxSend(); // åŸ·è¡Œæ’ç¨‹
			
			console.log("ajaxSend:" + new Date());
			
		},
		/**
		 * === ç§æœ‰å‡½å¼ï¼šrunNextAjaxSend() ===
		 * åŠŸèƒ½ï¼š
		 *   ä¾åºå¾ä½‡åˆ—ä¸­å–å‡ºè«‹æ±‚åŸ·è¡Œï¼Œç¢ºä¿æ¯ç­†é–“éš” 0.5-2 ç§’ã€‚
		 */
		async runNextAjaxSend() {
		  if (ajaxSendIsSending || ajaxSendQueue.length === 0) return;

		  ajaxSendIsSending = true;
		  const { req_data, loading } = ajaxSendQueue.shift();

		  console.log("ğŸš€ [ajaxSend] é–‹å§‹å‚³é€:", req_data.url, "æ™‚é–“:", new Date().toLocaleTimeString());

		  // === ä»¥ä¸‹ç‚ºåŸæœ¬ AJAX å‚³é€é‚è¼¯ ===
		  hiddenTime = new Date().getTime();
		  if (loading) $("#loading").removeClass("d-none");
		  req_data.data = JSON.stringify(req_data.data).replaceAll("!", "").replaceAll("=", "").replaceAll("\\t", "");

		  $.ajax({
		    url: "ajax/" + req_data.url,
		    type: req_data.type,
		    contentType: "application/json;charset=UTF-8",
		    dataType: 'json',
		    data: req_data.data,
		    timeout: 180000,
		    success(event) {
		      console.log("âœ… success:", new Date());
		      const mainAlertM = nav_alert.methods;
		      if (event['infoColor'] === "success") {
		        mainAlertM.alertshow(event['infoColor'], event['info']);
		      } else if (event['infoColor'] === "warning") {
		        mainAlertM.alertshow(event['infoColor'], event['info']);
		        $("#loading").addClass("d-none");
		        return;
		      } else {
		        mainAlertM.alertshow("danger", "[777] The command was executed [ERROR]!!");
		        $("#loading").addClass("d-none");
		        return;
		      }

		      main.resq_data = event;

		      if (event['htmlBody'] !== "") {
		        if (home.methods) { home.methods.destroy(); home = {}; }
		        if (search.methods) { search.methods.destroy(); search = {}; }
		        if (modify.methods) { modify.methods.destroy(); modify = {}; }
		        if (print.methods) { print.methods.destroy(); print = {}; }
		        if (report.methods) { report.methods.destroy(); report = {}; }
		        if (compare.methods) { compare.methods.destroy(); compare = {}; }
		        if (other.methods) { other.methods.destroy(); other = {}; }
		        body_index.methods.destroy(); body_index = {};

		        $("#body_page").load("./html/body/" + main.resq_data['htmlBody'], function () {
		          body_index.methods.create();
		          $('#nav_functional_unit').text(event['htmlBodyUnitName']);
		          $('#nav_functional_unit').attr('title', event['htmlBody'].replace('.html', '').replace('body_', ''));
		        });
		      } else if (event['callBackFunction'] !== "") {
		        switch (event['callBackFunction']) {
		          case "search": search.methods.searchReturn(); break;
		          case "modify": modify.methods.modifyReturn(); break;
		          case "report": report.methods.reportReturn(); break;
		          case "other_search": other.methods.otherReturn(); break;
		          case "other_detail_search": other.methods.otherDetailReturn(); break;
		          case "other_modify": other.methods.otherModifyReturn(); break;
		          case "other_other": other.methods.otherOtherReturn(); break;
		        }
		      } else {
		        mainAlertM.alertshow("danger", "[078] The command was executed [ERROR]!!");
		      }

		      $("#loading").addClass("d-none");
		    },
		    error(event) {
		      console.log("âŒ error:", new Date());
		      const mainAlertM = nav_alert.methods;
		      if (event.status === 200) {
		        mainAlertM.alertshow("warning", "[200] You have not logged in [ERROR]!!");
		        window.location.replace("login.basil");
		      } else if (event.status === 404) {
		        mainAlertM.alertshow("warning", "[404] The command failed [Warning]!!");
		      } else if (event.status === 403) {
		        mainAlertM.alertshow("warning", "[403] The command has been rejected (æ‚¨å¯èƒ½æ²’æœ‰æ¬Šé™!!) [Warning]!!");
		      } else {
		        mainAlertM.alertshow("danger", "[999] The command error [ERROR]!!" + event);
		      }
		      $("#loading").addClass("d-none");
		    },
		  });
		  // === Step 4. é–“éš” 0.5 ç§’å¾ŒåŸ·è¡Œä¸‹ä¸€ç­† ===
		  await new Promise(resolve => setTimeout(resolve, ajaxSendDelay));
		  ajaxSendIsSending = false;
		  main.methods.runNextAjaxSend();
		},
		
		
		orderedSort(title) {
			//æ’åºjsonObj åŠŸèƒ½(Order By Key)
			const ordered = Object.keys(title).sort().reduce((obj, key) => {obj[key] = title[key]; return obj;}, {});
			return ordered;
		},
		loading(open) {
			//è®€å–ä¸­ç•«é¢
			if (open) {
				t_alert.alertshow('close', "");
				$("#nav_loading").removeClass("d-none");
			} else {
				$("#nav_loading").addClass("d-none");
			}
		},
		reWindowsSize() {
			//è¦–çª—å¤§å°
			var modifyHeight = 100;
			var modifyDetailHeight = 100;
			console.log($("#myTab li .active").attr("id"));
			var title = $("#myTab li .active").attr("id");
			switch (title) {
				case "modify_title":
					//ä¿®æ”¹ä»‹é¢é«˜åº¦
					modifyHeight = window.innerHeight -
						$('#nav_index')[0].offsetHeight -
						$('#myTab')[0].offsetHeight -
						$('#modify_c_batch_revision_data')[0].offsetHeight -
						$('#modify_c_batch_revision_detail')[0].offsetHeight -
						$('#modify_c_controller')[0].offsetHeight -
						$('#footer_page')[0].offsetHeight - 45;
					if (modifyHeight > 100) {
						//Data
						$('#modifyThAll table').css('maxHeight', modifyHeight + 'px');
						//Detail
						modifyDetailHeight = (modifyHeight * 2) >
							(window.innerHeight - $('#nav_index')[0].offsetHeight - $('#myTab')[0].offsetHeight) ?
							(window.innerHeight - $('#nav_index')[0].offsetHeight - $('#myTab')[0].offsetHeight) : (modifyHeight * 2);
						$('#modifyTdAll table').css('maxHeight', modifyDetailHeight + 'px');
					}
					break;
				case "search_title":
					//æŸ¥è©¢ç•Œé¢é«˜åº¦
					modifyHeight = window.innerHeight -
						$('#nav_index')[0].offsetHeight -
						$('#myTab')[0].offsetHeight -
						$('#search_c_item')[0].offsetHeight -
						$('#search_c_controller')[0].offsetHeight -
						$('#search_dcr')[0].offsetHeight -
						$('#footer_page')[0].offsetHeight - 45;
					if (modifyHeight > 100) {
						$('#search_cr_open table').css('maxHeight', modifyHeight + 'px');
					}
					break;
				case "other_title":


					break;
			}
			//console.log(modifyHeight);
		},
	}
	//====Step2.è¼‰å…¥å‰µå»º====
	console.log("main.html(created)");
	//è³‡æ–™-æ¥æ”¶
	main.resq_data = JSON.parse(/*[[${initMain}]]*/+"");
	//console.log(main.resq_data);
	//console.log(JSON.parse(main.resq_data.entityJson));
	//æ¨¡æ¿-å®¶
	$("#header_page").load("./html/header/header_index.html", function () { });
	//æ¨¡æ¿-è²éŸ³è³‡è¨Š
	$("#nav_alert").load("./html/nav/nav_alert.html", function () {
	});
	//æ¨¡æ¿-å°è¦½
	$("#nav_page").load("./html/nav/nav_index.html", function () {
		nav_alert.methods.create();
		nav_index.methods.create();
	});
	//æ¨¡æ¿-ä¸»é«”
	$("#body_page").load("./html/body/body_index.html", function () {
		body_index.methods.create();
	});
	//æ¨¡æ¿-ç¶²ç«™å®£å‘Š
	$("#footer_page").load("./html/footer/footer_index.html", function () { });
	//æ¨¡æ¿-è®€å–ä¸­...
	$("#loading_page").load("./html/nav/loading.html", function () {
		loading.methods.create();
	});
	//æ¨¡æ¿-ç™»å‡ºä¸­...
	$("#logout_page").load("./html/nav/logout.html", function () { });
	//æ˜¯å¦ç‚ºæ‰‹æ©Ÿæ ¼å¼
	let check = false;
	(function (a) {if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;})(navigator.userAgent || navigator.vendor || window.opera);
	console.log("æ‰‹æ©Ÿæ ¼å¼? : " + check + ":" + window.devicePixelRatio);
	if (check) {
		$('html').css('fontSize', '150%');
		document.body.style.zoom = "" + 150 + "%";
	}

	//è¦–çª—å¤§å°
	$(window).off("resize");
	$(window).on("resize", function () {
		main.methods.reWindowsSize();
	});

	//è¦–çª—å¤§å°
	$(document).off("click", ".btn-outline-white");
	$(document).on("click", ".btn-outline-white", function (event) {
		main.methods.reWindowsSize();
		
	});
</script>

</html>