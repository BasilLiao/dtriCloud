<style>
/*Table 寬度滾動*/
#other_c .table-responsive {
	display: block;
	width: 100%;
	overflow-x: auto;
}

/*Table 自動隱藏*/
#other_c .table-responsive th, #other_c .table-responsive td {
	text-overflow: ellipsis;
	white-space: nowrap;
	overflow: hidden;
}

/*Table 表格固定*/
#other_c .fixedC1 {
	left: 0px;
	position: sticky;
}

#other_c .fixedCt {
	position: sticky;
	top: 0px;
	z-index: 5;
}

/*Table 每隔表格內_框線*/
#other_c .table-bordered td, #other_c .table-bordered th {
	border: 1px solid #1b76fd;
	padding: 2px;
}

/*Table 表格外框線*/
#other_c #other_cr table {
	max-height: 700px;
	min-height: 600px;
	border-collapse: separate;
	border-spacing: 0px;
}

/*Table 表格外框線*/
#other_c  #other_dcr_detail {
	max-height: 600px;
	min-height: 400px;
	border-collapse: separate;
	border-spacing: 0px;
	font-size: 28px;
	line-height: 35px;
}

/*Table 表格內 背景色*/
#other_c .table-white {
	--bs-table-bg: #fff;
}

/*覆寫換色*/
.table-hover>tbody>tr:hover>* {
	--bs-table-accent-bg: #0d6efd40;
	color: var(--bs-table-hover-color);
}

/*標題色彩*/
#other_c .title_color {
	background-color: #cfe2ff;
}

/*直立式呈現邊字*/
#other_c .wlr {
	writing-mode: vertical-lr;
	width: 20px;
}

/*checkbox_66*/
#other_c .checkbox_66 {
	width: 66px;
	height: 66px;
}

/*checkbox_36*/
#other_c .checkbox_36 {
	width: 36px;
	height: 36px;
}

/*checkbox_24*/
#other_c .checkbox_24 {
	width: 24px;
	height: 24px;
}

/*checkbox_24_60*/
#other_c .checkbox_24_60 {
	width: 60px;
	height: 24px;
}

#other_c .checkbox_20 {
	width: 20px;
	height: 20px;
}

#other_c .checkbox_16 {
	width: 16px;
	height: 16px;
}

#controller_command input:focus {
	background: #ffc107;
}

/*checkIn 高度*/
#searchCheckin input:focus {
	background: #ffc107;
}

#searchCheckin input {
	height: 100%;
}

/*高量顯示*/
.bg-show {
	background: #ffc1073b;
}

.bg-show-note {
	background: #dc3545;
}

.bg-warning-30 {
	background: #4dcf938f;
}
</style>
<div id="other_c" class="row p-0 m-0">
	<!-- 查詢-細節結果 -->
	<div id="other_dcr" class="col-12 m-0 p-1">
		<div
			class="col-12 p-0 m-0 pb-1 lh-1 text-start rounded-top bg-secondary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#other_dcr_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="other_dcr_open" class="row m-0 collapse">
			<b class="p-0 m-0 lh-1 wlr  bg-secondary text-white"> Result
				detail </b>
			<div class="col p-0" id="other_dcr_detail">
				<div class="row p-0 m-0">
					<div class="col-6 p-1 border border-secondary">入料單-未歸位(已核單)</div>
					<div class="col-6 p-1 border border-secondary">領料單-已領取(未核單)</div>
					<div class="col-6 p-1 border border-secondary" id="">
						<textarea id="f_wiincoming" rows="10" cols="23"
							style="font-size: 22px; line-height: 30px;"></textarea>
					</div>
					<div class="col-6 p-1 border border-secondary" id="">
						<textarea id="f_wishipping" rows="10" cols="23"
							style="font-size: 22px; line-height: 30px;"></textarea>
					</div>
				</div>
				<div class="row p-0 m-0">
					<div class="col-2 p-1 border border-secondary">盤日:</div>
					<div class="col-4 p-1 border border-secondary" id="f_widate"
						style="font-size: 20px;"></div>
					<div class="col-2 p-1 border border-secondary">盤人:</div>
					<div class="col-4 p-1 border border-secondary" id="f_wiuser"></div>
				</div>
				<div class="row p-0 m-0">
					<div class="col-2 p-1 border border-secondary">實數:</div>
					<div class="col-2 p-1 border border-secondary" id="f_wirqty"></div>
					<div class="col-2 p-1 border border-secondary">途數:</div>
					<div class="col-2 p-1 border border-secondary" id="f_witqty"></div>
					<div class="col-2 p-1 border border-secondary">帳數:</div>
					<div class="col-2 p-1 border border-secondary" id="f_winqty"></div>
					<!-- 存放本次ID -->
					<div class="col-2 p-1 border border-secondary d-none" id="f_id"></div>
				</div>
			</div>
		</div>
	</div>
	<!-- 查詢面板 -->
	<div id="other_c_item" class="col-12 p-1">
		<div
			class="col-12 p-0 m-0 pb-1 lh-1 text-start rounded-top bg-success text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#other_c_item_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div class="row m-0 collapse show" id="other_c_item_open">
			<b class="p-0 m-0 lh-1 wlr bg-success text-white"> Search </b>
			<div id="searchItem"
				class="col border border-primary  row m-0 p-0 shadow-sm">
				<div class="col-4 searchTextEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search1</div>
						<div class="p-1">
							<input class="col-12 m-0 p-1 border border-dark form-control"
								type=text id="ex_other_id" name="ex_name" placeholder="Ex:123">
						</div>
					</div>
				</div>
				<div class="col-4 searchSelectEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search2</div>
						<div class="p-1">
							<select class="col-12 m-0 p-1 border border-dark form-select"
								id="ex_other_id2" name="ex_name2">
								<option class="selectEx" value="" selected="selected">select(請選擇)</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 控制面板 -->
	<div id="other_c_controller" class="col-12 p-1 ">
		<div
			class="col-12 p-0 m-0 pb-1 lh-1 text-start rounded-top bg-primary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#other_c_controller_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="other_c_controller_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-primary text-white"> Console </b>
			<div
				class="col border border-primary row m-0 p-0 shadow-sm justify-content-between">
				<div class="col-12 col-lg-5 p-1">
					<div id="other_search_btn" class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Search</div>
						<div class="row m-0">
							<div class="lh-1 col p-1 m-1 border border-primary rounded">
								<input id="btn_send_auto" alt="" title="" type="checkbox"
									class="m-0 form-check-input checkbox_24_60 border border-dark">
								<br> <b style="font-size: 12px;">Auto(30s)</b>
							</div>
							<div class="col-4 p-1">
								<button id="btn_markCancel" type="button"
									class="lh-1 col-12 p-1 m-0  btn btn-sm btn-outline-danger"
									style="height: 100%">
									<b>All/M<br>cancel()
									</b>
								</button>
							</div>
							<div class="col-4 p-1">
								<button id="btn_send" type="button"
									class="lh-1 col-12 p-1 m-0  btn btn-sm btn-outline-success"
									style="height: 100%">
									<b>Query<br>(AR)
									</b>
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="col-12 col-lg-6 p-1">
					<div id="controller_command"
						class="border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Command</div>
						<div class="row m-0" style="min-height: 58px;">
							<div class="col-3 p-1">
								<button id="btn_detail" type="button"
									class="lh-1 col-12 p-1 m-0  btn btn-sm btn-outline-dark"
									style="height: 100%">
									<b>Detail<br>item()
									</b>
								</button>
							</div>
							<div class="col-4 p-1" id="command_send">
								<input class="lh-1 p-1 m-0 border border-dark rounded"
									type="text" value="" placeholder="倉別_料號"
									style="width: 100%; height: 100%" readonly="readonly" autofocus>
							</div>
							<div class="col-2 p-1" id="command_qty">
								<input class="lh-1 p-1 m-0 border border-dark rounded"
									type="number" value="" placeholder="盤點數"
									style="width: 100%; height: 100%" value="0">
							</div>
							<div class="col-3 p-1">
								<button id="btn_confirm" type="button"
									class="lh-1 col-12 p-1 m-0  btn btn-sm btn-outline-success"
									style="height: 100%">
									<b>Confrm<br>(S1)
									</b>
								</button>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
	<!-- 查詢結果 -->
	<div id="other_cr" class="col-12 m-0 p-1">
		<div
			class="col-12 p-0 m-0 pb-1 lh-1 text-start rounded-top bg-info text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#other_cr_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="other_cr_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-info text-white"> Result </b>
			<table
				class="col m-0 p-0 border border-primary table table-striped table-hover table-sm table-bordered border-primary table-responsive table-style shadow-sm">
				<thead class="table-primary fixedCt">
					<tr>
						<th class="fixedC1 align-middle" style="min-width: 80px;">
							<div>
								<button id="exthAll" type="button"
									class="checkbox_66 lh-1 col p-1 m-0 btn btn-sm btn-outline-dark">
									<b>M</b>
								</button>
							</div>
						</th>
						<th class="exTheadth d-none" style="min-width: 100px;">N/A</th>
					</tr>
				</thead>
				<tbody class="table-white">
					<tr class="exTbodyTr">
						<th class="fixedC1 align-middle exTbodyTh"
							style="max-width: 80px;">
							<div>
								<input name="radiobox" disabled="disabled" alt="row_x"
									title="IKey_GKey" type="radio"
									class="m-0 form-check-input checkbox_66 border border-dark">
							</div>
						</th>
						<td class="exTbodytd d-none" style="max-width: 100px"></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
	//宣告
	//console.log("other.html(init)");
	other = {
		//資料
		data: {
			marks: {},//有選取的IKeyGKey
			markDetails: {},//有選取的IKeyGKey
			marksLock: {},//有選取的IKeyGKey(鎖定)
			entityFormatJson: {},//查詢格式
			btn_send_auto: null,//自動傳送
			command_send:"",//上次指令
			//換頁設置
			searchPageSet: {
				total: 100,//批次數量(1-1000)
				batch: 0,//第幾批次(1-1000)
				pageNew: 1,//單前頁碼(1-50)
				pageSize: 100,//每頁數量(1-20)
				entityJsons: [],//資料
				entityDetailJsons: [],//細節資料
				entityDetailOpenJsons: [],//展開-細節資料
				entityIKey: "",//ID
				entityGKey: "",//GID
				entityDateTime: "",//是時間格式的欄位 
			},
			searchSet: {},
		},
		//方法
		methods: {
			create() {
				//==========================第一次載入==========================
				//Step0.初始化
				console.log("other.html(created)");
				//查詢格式
				other.data.entityFormatJson = JSON.parse(main.resq_data['entityFormatJson']);
				//查詢項目 
				let searchSetJson = JSON.parse(main.resq_data['searchSet']);
				//console.log(searchSetJson);
				//資料內容
				other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
				other.data.searchPageSet.entityDetailJsons = JSON.parse(main.resq_data['entityDetailJson']);
				other.data.entityIKey = main.resq_data['entityIKeyGKey'].split("_")[0];
				other.data.entityGKey = main.resq_data['entityIKeyGKey'].split("_")[1];
				other.data.entityDateTime = main.resq_data['entityDateTime'];
				other.data.searchSet = searchSetJson['searchSet'];
				//按鈕權限?
				let p = $("#nav_functional_unit").attr("alt").split("<_>")[2];
				let ps = Array.from(p);
				
				if (ps[10] != 1) {//查詢(AR)10
					$("#other_c #btn_send").addClass("disabled");
				} if (ps[5] != 1) {//修改(S1)5
					$("#other_c #btn_confirm").addClass("disabled");
				}
				
				
				//Step1.查詢結果標題-排序
				let resultThead = searchSetJson['resultThead'];
				resultThead = main.methods.orderedSort(resultThead);
				//console.log(resultThead);
				//Step2.查詢結果標題-資料
				let check1 = true;
				//合併存格
				let mergeCell = 1;
				let exTheadth = "";
				let exTbodytd = "";
				Object.keys(resultThead).forEach(function (k) {
					//console.log(k + ' - ' + resultThead[k]);
					//3合併->1
					if (mergeCell == 1) {
						//Step1-1.複製格式
						exTheadth = $('#other_cr_open .exTheadth').clone();
						exTbodytd = $('#other_cr_open .exTbodytd').clone();
						exTheadth.removeClass('exTheadth');
						exTheadth.removeClass('d-none')
						exTheadth.addClass('titTheadth');
						//
						exTbodytd.removeClass('exTbodytd');
						exTbodytd.removeClass('d-none')
						exTbodytd.addClass('valTbodytd');
						//exTbodytd.addClass(resultThead[k].cellName);
						mergeCell = mergeCell + 1;
					} else {
						if (mergeCell == 3) {
							mergeCell = 1;
							//添加
							$('#other_cr_open .exTheadth').before(exTheadth);
							$('#other_cr_open .exTbodytd').before(exTbodytd);
						} else {
							mergeCell = mergeCell + 1;
						}
					}
					//Step1-2.添加分割
					exTbodytd.html(exTbodytd.html() + "<div style='min-height: 24px;' class='" + resultThead[k].cellName + "'></div>");

					//Step1-3.固定第一格式
					if (check1 && resultThead[k].show == 1) {
						check1 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', "80px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', "80px");
					}
					//Step1-4.如果有翻譯
					if (resultThead[k].cellLanguage != '') {
						let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
						cellName = cellName == "" ? resultThead[k].cellName : cellName
						let cellText = exTheadth.html() == "N/A" ? "" : exTheadth.html();//有可能內容是空的
						exTheadth.html(cellText + "<div>" + cellName + "</div>");
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
					} else {
						let cellText = exTheadth.html() == "N/A" ? "" : exTheadth.html();
						exTheadth.html(cellText + "<div>" + resultThead[k].cellName + "</div>");
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
					}
					//Step1-5.如果隱藏->直接指定特定欄位
					//倉儲名_儲位_物料號_
					// ===== 允許顯示的欄位名稱（白名單）=====
					const visibleCellNames = new Set([
					    'wiwaaliasname',
					    'wiwaslocation',
					    'wiwmpnb',
					    'wirqty',
					    'winqty',
					    'witqty',
					    'wiuser',
					    'winowqty',
					    'wignowqty'
					]);
					if (visibleCellNames.has(resultThead[k].cellName)) {
						exTheadth.removeClass('d-none');
						exTbodytd.removeClass('d-none');

					}else{
						//其他不顯示
						exTheadth.addClass('d-none');
						exTbodytd.addClass('d-none');
					}
				});

				
				//Step3.查詢內容-格式
				let pageSize = other.data.searchPageSet.pageSize;
				for (let b = 1; b <= pageSize; b++) {
					let exTbodyTr = $('#other_cr_open .exTbodyTr').clone();
					exTbodyTr.removeClass('exTbodyTr');
					exTbodyTr.removeClass('d-none');
					exTbodyTr.addClass('valTbodyTr_' + b);
					exTbodyTr.find('input').attr("alt", "row_" + b);
					$('#other_cr_open .exTbodyTr').before(exTbodyTr);
				}
				$('#other_cr_open .exTbodyTr').addClass('d-none');

				//Step4.查詢條件
				for (let t = 0; t < searchSetJson['searchSet'].length; t++) {
					let searchSet = searchSetJson['searchSet'][t];
					let searchTextEx = "";
					let searchSelectEx = "";
					let selectEx = "";
					//不顯示
					const showCellNames = new Set([
					    'wiwaaliasnb',
					    'wiwaslocation',
					    'esyscdate',
					]);
					if (!showCellNames.has(searchSet['searchName'])) {
						continue;
					}
					if (searchSet['type'] != 'select') {
						//一般文字
						searchTextEx = $('#other_c_item .searchTextEx').clone();
						searchTextEx.removeClass("searchTextEx");
						searchTextEx.removeClass("col-md-1");
						searchTextEx.removeClass("d-none");
						searchTextEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchTextEx.find('input').attr("id", "other_"+searchSet['searchName']);
						searchTextEx.find('input').attr("name", "other_"+searchSet['searchName']);
						searchTextEx.find('input').attr("placeholder", searchSet['placeholder']);
						searchTextEx.find('input').addClass("searchVal");
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchTextEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchTextEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
					} else {
						//選擇選單
						searchSelectEx = $('#other_c_item  .searchSelectEx').clone();
						searchSelectEx.removeClass("searchSelectEx");
						searchSelectEx.removeClass("col-md-1");
						searchSelectEx.removeClass("d-none");
						searchSelectEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchSelectEx.find('select').attr("id", "other_"+searchSet['searchName']);
						searchSelectEx.find('select').attr("name", "other_"+searchSet['searchName']);
						searchSelectEx.find('select').addClass("searchVal");
						//查詢欄位
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchSelectEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchSelectEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
						//選項
						for (let s = 0; s < searchSet['select'].length; s++) {
							let key = searchSet['select'][s].split("_")[0];
							let val = searchSet['select'][s].split("_")[1];
							selectEx = searchSelectEx.find('.selectEx').clone();
							selectEx.removeClass("selectEx");
							selectEx.removeAttr("selected");
							selectEx.text(key);
							selectEx.val(val);
							selectEx.appendTo(searchSelectEx.find('select'));
						}
					}
					switch (searchSet['type']) {
						case "select":
							searchSelectEx.appendTo('#other_c_item  #searchItem');
							break;
						case "text":
							searchTextEx.appendTo('#other_c_item #searchItem');
							break;
						case "time":
							searchTextEx.find('input').addClass('datetimepicker_time');
							searchTextEx.appendTo('#other_c_item #searchItem');
							break;
						case "date":
							searchTextEx.find('input').addClass('datetimepicker_date');
							searchTextEx.appendTo('#other_c_item #searchItem');
							break;
						case "datetime":
							searchTextEx.find('input').addClass('datetimepicker_datetime');
							searchTextEx.appendTo('#other_c_item #searchItem');
							break;
					}
				}
				//時間格式
				other.methods.datetimepickerDate();
				//Step5.帶入資料
				other.methods.otherReLoad();

				//==========================監聽==========================
				//監聽-選取資料
				$(document).off("change", "#other_c #other_cr_open .exTbodyTh input");
				$(document).on("change", "#other_c #other_cr_open .exTbodyTh input", function (event) {
					console.log("other_cr_open");
					$('#other_c #btn_detail').trigger('click');//細節(開關)
				});
				//監聽-選取資料
				$(document).off("change", "#other_c #other_dcr_open .exTbodyTh input");
				$(document).on("change", "#other_c #other_dcr_open .exTbodyTh input", function (event) {
					console.log("other_dcr_open");
					let Ikey_Gkey = event.target.title;
					let check = event.target.checked;
					let mark = {};
					//標記-選取|解除
					if (check == true) {
						other.data.markDetails[Ikey_Gkey] = true;
					} else {
						for (let k in other.data.markDetails) {
							if (k == Ikey_Gkey) {
								delete other.data.markDetails[k];
								break;
							};
						}
					}
					//console.log(other.data.markDetails);				
				});
				//監聽-細節
				$(document).off("click", "#other_c #btn_detail");
				$(document).on("click", "#other_c #btn_detail", function (event) {
					console.log("btn_detail");
					let marks = other.data.marks;
					let markDetails = other.data.markDetails;
					$(".valTbodyTrD").remove();
					//準備細節自動查詢用
					other.data.marksLock = marks;
					//重新對焦
					$("#command_send input").focus();
					
					//顯示細節資料
					let $checkTr = $('#other_cr_open tbody tr input:checked').closest('tr');
					//
					// 定義一個處理函式：解析 JSON 並用換行符號連接
					const parseArrayText = (text) => {
					    try {
					        // 如果 text 是空字串或無效，回傳空字串
					        return text ? JSON.parse(text).join('\n') : '';
					    } catch (e) {
					        console.error("JSON 解析失敗，回退至原始文字", e);
					        return text; // 解析失敗時至少回傳原始值
					    }
					};
					let checkID = $('#other_c #f_id').text() === $checkTr.find('.wiid').text();//id 是否同一個ID?
					$('#other_c #f_id').text($checkTr.find('.wiid').text());//id
					let wishipping = parseArrayText($checkTr.find('.wishipping').text());
					let wiincoming = parseArrayText($checkTr.find('.wiincoming').text());
					$('#other_c #f_wishipping').val(wishipping);
					$('#other_c #f_wiincoming').val(wiincoming);
					//
					$('#other_c #f_wishipping').text($checkTr.find('.wishipping').text());
					$('#other_c #f_wishipping').text($checkTr.find('.wishipping').text());
					
					//
					$('#other_c #f_wirqty').text($checkTr.find('.wirqty').text());
					$('#other_c #f_witqty').text($checkTr.find('.witqty').text());
					$('#other_c #f_winqty').text($checkTr.find('.winqty').text());
					$('#other_c #f_widate').text($checkTr.find('.widate').text());
					$('#other_c #f_wiuser').text($checkTr.find('.wiuser').text());
					
					
					//預設盤點數
					// 1. 獲取原始字串，並去除前後空白 (.trim())
					// 2. 使用 Number() 或 parseInt() 強制轉型，若非數字則給予預設值 0 (|| 0)
					const winQty = Number($checkTr.find('.winqty').text().trim()) || 0;
					const witQty = Number($checkTr.find('.witqty').text().trim()) || 0;
					
					// 3. 執行數學加法
					const command_qty = winQty - witQty;
					//Console Log 方便除錯
					console.log(`盤點計算: 帳面(${winQty}) - 在途(${witQty}) = 預設盤點數(${command_qty})`);
					$('#other_c #command_qty input').val(command_qty);
					
					//Step4.觸發(切換<->查詢模式/細節模式)?
					if($('#other_c #other_dcr_open').hasClass('show')){
					//細節模式->查詢模式
						if(checkID){//同樣的ID 才可再轉換
							$('#other_dcr i').trigger('click');//細節(開關)
							$('#other_search_btn').removeClass('d-none');//查詢按鈕-打開
							if(!$('#other_c #other_c_item_open').hasClass('show')){
								$('#other_c_item i').trigger('click');//查詢介面
							}							
						}
					}else{
						//查詢模式->細節模式
						$('#other_dcr i').trigger('click');//細節(開關)
						$('#other_search_btn').addClass('d-none');//查詢關閉
						if($('#other_c #other_c_item_open').hasClass('show')){
							$('#other_c_item i').trigger('click');//查詢介面
						}	
					}
				});


				//監聽-標記移除
				$(document).off("click", "#other_c #btn_markCancel");
				$(document).on("click", "#other_c #btn_markCancel", function (event) {
					console.log("btn_markCancel");
					other.data.marks = [];
					other.data.markDetails = [];
					$('#other_c .exTbodyTh input').prop("checked", false);
					$('#other_c #command_send input').val("");
					$('#other_c #command_qty input').val("");
					$("#other_c #btn_send_auto").prop("checked", false);
					//clearTimeout(other.data.btn_send_auto);

					//
					$("#other_c #searchItem input").val("");
					$("#other_c #searchItem select").val("");
					$('#other_c #f_id').text("");//id
					$('#other_c #f_wishipping').val("");
					$('#other_c #f_wiincoming').val("");
					//
					$('#other_c #f_wishipping').text("");
					$('#other_c #f_wishipping').text("");
					
					//
					$('#other_c #f_wirqty').text("");
					$('#other_c #f_witqty').text("");
					$('#other_c #f_winqty').text("");
					$('#other_c #f_widate').text("");
					$('#other_c #f_wiuser').text("");

				});

				//監聽-修改傳送
				$(document).off("click", "#other_c #btn_confirm");
				$(document).on("click", "#other_c #btn_confirm", function (event) {
					console.log("btn_confirm");
					//將資料回填
					//取得選擇的物件
					let $checkTr = $('#other_cr_open tbody tr input:checked').closest('tr');
					let f_wiid = $('#other_c #f_id').text();
					//確定同一筆才能存
					if(f_wiid === $checkTr.find('.wiid').text()){
						$checkTr.find('.winowqty').text($('#other_c #command_qty input').val());//盤點數
						other.methods.confirmSend();					
					}
					//			
				});
				// #searchItem 內所有 input 取得焦點時，自動全選內容
				$(document).off("focus", "#other_c #searchItem div input");
				$(document).on('focus', '#other_c #searchItem div input', function () {
				    // 排除 disabled 或 readonly
				    if (this.disabled || this.readOnly) return;

				    // 延遲一個 tick，避免某些瀏覽器被點擊事件覆蓋
				    setTimeout(() => {
				        this.select();
				    }, 0);
				});
				
				//監聽-查詢
				$(document).off("click", "#other_c #btn_send");
				$(document).on("click", "#other_c #btn_send", function (event) {
					console.log("btn_send");
					other.methods.searchSend(0);
				});
				//監聽-查詢(促發)
				$(document).off("keyup", "#other_c #searchItem input");
				$(document).on("keyup", "#other_c #searchItem input", function (e) {
					if (e.key === 'Enter' || e.keyCode === 13) {
						$(e.currentTarget).select();
						$("#other_c #btn_send").trigger("click");
					}
				});
				//監聽-(command促發)
				$(document).off("keydown", "#command_send input");
				$(document).on("keydown", "#command_send input", function (e) {
					//console.log(e.key);
					//清除?輸入?送出?
					if (e.key == 'Backspace') {
						$('#other_c #command_send input').val("");
					} else if (e.key == 'Enter') {
						//觸發傳送(單一倉儲_物料)
						$('#other_c #searchItem #other_wiwaaliasnb').val($('#other_c #command_send input').val());
						//重複輸入 = 驗證指令/反之 = 查詢指令
						if(other.data.command_send === $('#other_c #command_send input').val()){							
							other.data.command_send = "";							
							//2次確認->送出
							$("#other_c #btn_confirm").trigger("click");
						}else{
							//查詢
							other.data.command_send = $('#other_c #command_send input').val();
							$("#other_c #btn_send").trigger("click");
						}
						$('#other_c #command_send input').val("");
						
					} else if (e.key == 'Shift') {
						//排除
					} else {
						//輸入
						let command_val = $("#other_c #command_send input").val();
						$('#other_c #command_send input').val(command_val + e.key);
					}
					$("#other_c #command_send input").focus();
				});
				
				
				

				//監聽-切換對焦
				$(document).off("keydown", "#command_qty input");
				$(document).on("keydown", "#command_qty input", function (e) {
					if (e.key == 'Enter') {
						$("#command_send input").focus();
					}
				});
				//監聽-選取對焦
				$(document).off("focus", "#command_qty input");
				$(document).on("focus", "#command_qty input", function (e) {
					
					// 儲存當前物件 context
				    const $this = $(this);
				    
				    // 延遲 0 毫秒執行 (這是 JavaScript 常見的 Trick)
				    setTimeout(function() {
				        $this.select();
				    }, 0);
				});

				//時間格式
				other.methods.datetimepickerDate();
				//預設對焦
				$("#command_send input").focus();
			},
			datetimepickerDate() {
				//日期時間格式
				$('#other_c .datetimepicker').remove();
				$('#other_c .datetimepicker_date:not(:disabled)').datetimepicker({
					format: 'yyyy-mm-dd',
					pickerPosition: 'bottom-right',
					startView: 2,    // 2 = month view（年/月/日）
				    minView: 2,      // 2 = 最小停在「日」
				    autoclose: true,
				    endDate: '+1d',
				    datesDisabled: '+1d',
				    todayBtn: true,
				    bootcssVer: 5
					//......可以同上項目代碼自定義設置
				});
				$('#other_c .datetimepicker_datetime:not(:disabled)').datetimepicker({
					format: 'yyyy-mm-dd hh:ii:00',
					pickerPosition: 'bottom-right',
					//minView:1,
					// hoursDisabled: [00, 1, 2, 3, 4, 5, 6],
					minuteStep: 30,
					autoclose: true,
					endDate: '+1d',
					datesDisabled: '+1d',
					todayBtn: true,
					bootcssVer: 5,
					//......可以同上項目代碼自定義設置
				});
				//時間格式
				$('#other_c .datetimepicker_time:not(:disabled)').datetimepicker({
					format: 'hh:ii',
					startView: 1,
					minuteStep: 30,
					pickDate: false,
					autoclose: true,
					timeFormat: 'hh:mm',
				});
			},

			//==========================傳送資料==========================
			confirmSend() {
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
				let markDetails = other.data.markDetails;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;
				let dataBady = [];

				//單一筆資料-送出
				let $checkTr = $('#other_cr_open tbody tr input:checked').closest('tr');
								
				let entityJosn = {};
				$checkTr.find('.valTbodytd div').each(function (index) {
					let val = $(this).text() == "[N/A]" ? "" : $(this).text();
					let name = $(this).attr('class').split(' ')[0];
					//可能是時間格式
					if (entityDateTime.indexOf(name) >= 0) {
						val = new Date(val).getTime();
					}
					entityJosn[name] = val;
				});
				dataBady.push(entityJosn);
				
				

				console.log(dataBady);
				let action = "";
				let type = "PUT";
				let data = null;
				let req_data = {};
				let searchPageSet = {};
				if (dataBady.length > 0) {
					action = "S1";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataBady);
					data['entityDetailJson'] = JSON.stringify('{}');
				}
				if (data != null) {
					//包裝
					data['callBackFunction'] = "other_modify";
					req_data['data'] = data;
					req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil." + action;//AC/AD....
					req_data['type'] = type;//POST/PUT/DELETE...
					main.methods.ajaxSend(req_data, true);
				}
				return false;
			},
			//一般查詢V
			searchSend(batch) {
				//$('#other_cr_open table,#other_dcr_open table').animate({scrollTop: 0}, 'slow');
				let entityJson = other.data.entityFormatJson;//格式
				let data = {};
				let req_data = {};
				let searchPageSet = {};
				//查詢
				$("#other_c #searchItem .searchVal").each(function (index) {
					//console.log(index+" : "+$(this).attr("id")+" : "+$(this).val());
					let keyJson = $(this).attr("id").replaceAll('other_','');
					let valJson = $(this).val();
					if ($(this).hasClass('datetimepicker_date') && $(this).val() != "") {
						entityJson[keyJson] = new Date(valJson).getTime();
					} else {
						entityJson[keyJson] = valJson == "" ? null : valJson;
					}
				});
				data['entityJson'] = JSON.stringify(entityJson);
				//換頁
				searchPageSet['total'] = other.data.searchPageSet.total;//批次數量
				searchPageSet['batch'] = batch;//第幾批次
				data['searchPageSet'] = JSON.stringify(searchPageSet);
				data['callBackFunction'] = "other_search";
				//包裝
				req_data['data'] = data;
				req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil.AR";
				req_data['type'] = "POST";
				main.methods.ajaxSend(req_data, false);

				//取消對焦
				const $focused = $('#other_c #searchItem input:focus');
			    if ($focused.length) {
			        $focused.blur();
			    }

			},

			//==========================資料載入==========================
			otherReLoad() {
				//還原
				$('#other_cr .valTbodytd div').text("");
				$('.exTbodyTh input').attr("disabled", "disabled");
				$('other_cr_open .exTbodyTh input').attr("title", "IKey_GKey");
				$('#other_cr .exTbodyTh input').prop("checked", false);
				$('#other_cr td div').removeClass("bg-warning");
				$('#other_cr td div').removeClass("bg-danger");
				$('#other_cr td div').removeClass("bg-warning-30");
				// 1. 選取 html 與 body：
			    //    是為了相容不同瀏覽器 (Chrome/Safari 吃 body, Firefox/IE 吃 html)
			    const $viewport = $('html, body');

			    // 2. 執行動畫
			    //    scrollTop: 0 -> 目標位置 (頂部)
			    //    800          -> 動畫時間 (毫秒)，可依需求調整速度
			    //    'swing'      -> jQuery 預設的曲線效果 (可省略，預設即為 swing)
			    $viewport.animate({
			        scrollTop: 0
			    }, 800);


				//Step5.帶入資料
				let marks = other.data.marks;
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;
				let pageSize = other.data.searchPageSet.pageSize;//每頁數量(1-20)
				let pageNew = other.data.searchPageSet.pageNew - 1;//單前頁碼(1-50)
				let pageSN = pageSize * pageNew;//目前分頁->資料戳記
				for (let x = 0; x < pageSize; x++) {
					//筆數還夠
					if (pageSN + x < entityJsons.length) {
						let entity = entityJsons[pageSN + x];//((目前頁碼-1)*每頁數量)+x
						let iKey = "";
						let gKey = "";
						let valTrNb = x + 1;
						let valTbodyTr_ = $('.valTbodyTr_' + valTrNb);
						Object.keys(entity).forEach(function (k) {
							//欄位計數
							valTbodyTr_.find(' th input').removeAttr("disabled");
							//是否IKEY?
							if (entityIKey == k) {iKey = entity[k];}
							//是否GKEY?
							if (entityGKey == k) {gKey = entity[k];}
							//是否時間格式?
							if (entityDateTime.indexOf(k) >= 0) {
								let dF = new Date(entity[k]);
								let dateF = dF.getFullYear() + "-";
								dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
								dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
								dateF += (dF.getHours() < 10 ? "0" + dF.getHours() : dF.getHours()) + ":";
								dateF += (dF.getMinutes() < 10 ? "0" + dF.getMinutes() : dF.getMinutes()) + ":";
								dateF += (dF.getSeconds() < 10 ? "0" + dF.getSeconds() : dF.getSeconds());
								valTbodyTr_.find(' .' + k).text(dateF);
							} else {
								valTbodyTr_.find(' .' + k).text(entity[k]);
							}

							//marks標記?
							valTbodyTr_.find(' input').attr("title", iKey + "_" + gKey);
							//帶入
							for (let m = 0; m < marks.length; m++) {
								if (marks[m].Ikey_Gkey == iKey + "_" + gKey) {
									valTbodyTr_.find(' input').prop("checked", true);
									break;
								}
							}
						});
					}
				}
				//自動展開->只有一筆資料時候->
				if(entityJsons.length==1){
					$('#other_cr_open tbody tr input').first().trigger('click');
					//介面沒有開?
					//Step4.觸發(切換<->查詢模式/細節模式)?
					if(!$('#other_c #other_dcr_open').hasClass('show')){					
						$('#other_c #btn_detail').trigger('click');//查詢介面
					}else{
						//顯示細節資料
						let $checkTr = $('#other_cr_open tbody tr input:checked').closest('tr');
						//
						// 定義一個處理函式：解析 JSON 並用換行符號連接
						const parseArrayText = (text) => {
						    try {
						        // 如果 text 是空字串或無效，回傳空字串
						        return text ? JSON.parse(text).join('\n') : '';
						    } catch (e) {
						        console.error("JSON 解析失敗，回退至原始文字", e);
						        return text; // 解析失敗時至少回傳原始值
						    }
						};
						$('#other_c #f_id').text($checkTr.find('.wiid').text());
						let wishipping = parseArrayText($checkTr.find('.wishipping').text());
						let wiincoming = parseArrayText($checkTr.find('.wiincoming').text());
						$('#other_c #f_wishipping').val(wishipping);
						$('#other_c #f_wiincoming').val(wiincoming);
						//
						$('#other_c #f_wishipping').text($checkTr.find('.wishipping').text());
						$('#other_c #f_wishipping').text($checkTr.find('.wishipping').text());
						
						//
						$('#other_c #f_wirqty').text($checkTr.find('.wirqty').text());
						$('#other_c #f_witqty').text($checkTr.find('.witqty').text());
						$('#other_c #f_winqty').text($checkTr.find('.winqty').text());
						$('#other_c #f_widate').text($checkTr.find('.widate').text());
						$('#other_c #f_wiuser').text($checkTr.find('.wiuser').text());
						
						//預設盤點數
						// 1. 獲取原始字串，並去除前後空白 (.trim())
						// 2. 使用 Number() 或 parseInt() 強制轉型，若非數字則給予預設值 0 (|| 0)
						const winQty = Number($checkTr.find('.winqty').text().trim()) || 0;
						const witQty = Number($checkTr.find('.witqty').text().trim()) || 0;
						
						// 3. 執行數學加法
						const command_qty = winQty - witQty;
						//Console Log 方便除錯
						console.log(`盤點計算: 帳面(${winQty}) - 在途(${witQty}) = 預設盤點數(${command_qty})`);
						$('#other_c #command_qty input').val(command_qty);
					}
				}
			},
			//==========================回傳接收==========================
			//修改後回傳
			otherModifyReturn() {
				if (main.resq_data.callBackValue != "") {
				//如果有特殊情況?				
				} else {
					//還原
					$('#other_c #f_id').text("");//id
					$('#other_c #f_wishipping').val("");
					$('#other_c #f_wiincoming').val("");
					//
					$('#other_c #f_wishipping').text("");
					$('#other_c #f_wishipping').text("");
					
					//
					$('#other_c #f_wirqty').text("");
					$('#other_c #f_witqty').text("");
					$('#other_c #f_winqty').text("");
					$('#other_c #f_widate').text("");
					$('#other_c #f_wiuser').text("");
					$('#other_c #command_qty input').val("");

					//重新查詢
					other.methods.searchSend(0);
				}
			},
			//查詢後回傳
			otherReturn() {
				console.log("otherReturn:" + new Date());
				//Step4.分頁歸位
				if (main.resq_data['entityJson'].length > 0) {
					let searchPageSet = JSON.parse(main.resq_data['searchPageSet']);
					other.data.searchPageSet.total = searchPageSet['total'];
					other.data.searchPageSet.batch = searchPageSet['batch'];
					other.data.searchPageSet.pageNew = 1; //單前頁碼(1-50)
					other.data.marks = {};//有選取的IKeyGKey
					other.data.markDetails = {};//有選取的IKeyGKey
					//Step5.帶入資料
					if (main.resq_data['entityJson'] != "") {
						other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
						other.methods.otherReLoad();
					}
					if (main.resq_data['entityDetailJson'] != "") {
						other.data.searchPageSet.entityDetailJsons = JSON.parse(main.resq_data['entityDetailJson']);
					}
				}
			},
			//==========================初始化==========================
			destroy() {
				//銷毀
				clearTimeout(other.data.btn_send_auto);

				$(document).off("keyup", "#other_c #searchItem input");
				$(document).off("click", "#other_c #btn_send");
				$(document).off("click", "#other_c #btn_markCancel");
				$(document).off("click", "#other_c #btn_confirm");
				$(document).off("focus", "#other_c #searchItem div input");

				$(document).off("keydown", "#command_send input");
				$(document).off("keydown", "#command_qty input");
				$(document).off("focus", "#command_qty input");
				$(document).off("keydown", "#searchCheckin input");


				$(document).off("click", "#other_c #btn_detail");
				$(document).off("change", "#other_c #other_dcr_open .exTbodyTh input");
				$(document).off("change", "#other_c #other_cr_open .exTbodyTh input");
				console.log("other.html(destroy)");
			},
		},
	};
</script>