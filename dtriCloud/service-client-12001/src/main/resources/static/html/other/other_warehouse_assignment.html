<style>
/*Table 寬度滾動*/
#search_c .table-responsive {
	display: block;
	width: 100%;
	overflow-x: auto;
}

/*Table 自動隱藏*/
#search_c .table-responsive th, #search_c .table-responsive td {
	text-overflow: ellipsis;
	white-space: nowrap;
	overflow: hidden;
}

/*Table 表格固定*/
#search_c .fixedC1 {
	left: 0px;
	position: sticky;
}

#search_c .fixedCt {
	position: sticky;
	top: 0px;
	z-index: 5;
}

/*Table 每隔表格內_框線*/
#search_c .table-bordered td, #search_c .table-bordered th {
	border: 1px solid #1b76fd;
	padding: 2px;
}

/*Table 表格外框線*/
#search_c #search_cr table {
	max-height: calc(100vh - 420px);
	min-height: 200px;
	border-collapse: separate;
	border-spacing: 0px;
}

/*Table 表格外框線*/
#search_c #search_dcr table {
	max-height: calc(100vh - 420px);
	border-collapse: separate;
	border-spacing: 0px;
}

/*Table 表格內 背景色*/
#search_c .table-white {
	--bs-table-bg: #fff;
}

/*覆寫換色*/
.table-hover>tbody>tr:hover>* {
	--bs-table-accent-bg: #0d6efd40;
	color: var(--bs-table-hover-color);
}

/*標題色彩*/
#search_c .title_color {
	background-color: #cfe2ff;
}

/*直立式呈現邊字*/
#search_c .wlr {
	writing-mode: vertical-lr;
	width: 20px;
}

/*checkbox_24*/
#search_c .checkbox_24 {
	width: 24px;
	height: 24px;
}

#search_c .checkbox_20 {
	width: 20px;
	height: 20px;
}

#search_c .checkbox_16 {
	width: 16px;
	height: 16px;
}
</style>
<div id="search_c" class="row p-0 m-0">
	<!-- 查詢面板 -->
	<div id="search_c_item" class="col-12 p-1">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-success text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#search_c_item_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div class="row m-0 collapse show" id="search_c_item_open">
			<b class="p-0 m-0 lh-1 wlr bg-success text-white"> Search </b>
			<div id="searchItem"
				class="col border border-primary  row m-0 p-0 shadow-sm">
				<div class="col-6 searchTextEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search1</div>
						<div class="p-1">
							<input class="col-12 m-0 p-1 border border-dark form-control"
								type=text id="ex_id" name="ex_name" placeholder="Ex:123"
								autofocus>
						</div>
					</div>
				</div>
				<div class="col-6 searchSelectEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search2</div>
						<div class="p-1">
							<select class="col-12 m-0 p-1 border border-dark form-select"
								id="ex_id2" name="ex_name2">
								<option class="selectEx" value="" selected="selected">select(請選擇)</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 控制面板 -->
	<div id="search_c_controller" class="col-12 p-1 ">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-primary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#search_c_controller_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_c_controller_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-primary text-white"> Console </b>
			<div
				class="col border border-primary row m-0 p-0 shadow-sm justify-content-between">
				<div class="col-12 col-lg-7 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Execution</div>
						<div class="row m-0">
							<button id="btn_detail" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-dark">
								<b>Detail<br>()
								</b>
							</button>
							<button id="btn_agree" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-primary">
								<b>Agree<br>(S1)
								</b>
							</button>
							<button id="btn_passAll" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-secondary">
								<b>Pass all<br>(S2)
								</b>
							</button>
							<button id="btn_returnSelect" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-danger">
								<b>Return<br>select(S3)
								</b>
							</button>
							<button id="btn_urgency" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning">
								<b>Urgency<br>(S4)
								</b>
							</button>
							<button id="btn_merge" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Merge<br>(S4)
								</b>
							</button>
							<button id="btn_manufacturePass" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-info">
								<b>Manufacture<br>pass(S5)
								</b>
							</button>
							<button id="btn_compare" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-primary">
								<b>Compare<br>()
								</b>
							</button>
							<button id="btn_markCancel" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-primary">
								<b>Mark<br>cancel()
								</b>
							</button>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Action</div>
						<div class="row m-0">
							<div class="lh-1 col p-1 m-1 border border-primary rounded">
								<input id="btn_only_have_qty" alt="" title="" type="checkbox"
									checked="checked"
									class="m-0 form-check-input checkbox_16 border border-dark">
								<br> <b style="font-size: 12px;">Have qty</b>
							</div>
							<button id="btn_printerForm" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-info">
								<b>Printer<br>form(S1)
								</b>
							</button>
							<button id="btn_confirm" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Confirm<br>(S1~S5)
								</b>
							</button>
							<button id="btn_re_synchronize" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning">
								<b>Re doc<br>sync(AR)
								</b>
							</button>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-2 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Search</div>
						<div class="row m-0">
							<div class="lh-1 col p-1 m-1 border border-primary rounded">
								<input id="btn_send_auto" alt="" title="" type="checkbox"
									class="m-0 form-check-input checkbox_16 border border-dark">
								<br> <b style="font-size: 12px;">Auto(30s)</b>
							</div>
							<button id="btn_send" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Query<br>(AR)
								</b>
							</button>
							<button id="btn_clearAll" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning">
								<b>Clear<br>all()
								</b>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 查詢結果 -->
	<div id="search_cr" class="col-12 m-0 p-1">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-info text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#search_cr_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_cr_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-info text-white"> Result </b>
			<table
				class="col m-0 p-0 border border-primary table table-striped table-hover table-sm table-bordered border-primary table-responsive table-style shadow-sm">
				<thead class="table-primary fixedCt">
					<tr>
						<th class="fixedC1" style="min-width: 40px;">
							<div>
								<button id="exthAll" type="button"
									class="lh-1 col p-1 m-0 btn btn-sm btn-outline-dark">
									<b>M</b>
								</button>
							</div>
						</th>
						<th class="exTheadth d-none" style="min-width: 100px;">N/A</th>
					</tr>
				</thead>
				<tbody class="table-white">
					<tr class="exTbodyTr">
						<th class="fixedC1 exTbodyTh" style="max-width: 40px;">
							<div>
								<input disabled="disabled" alt="row_x" title="IKey_GKey"
									type="checkbox"
									class="m-0 form-check-input checkbox_24 border border-dark">
							</div>
						</th>
						<td class="exTbodytd d-none" style="max-width: 100px"></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<!-- 查詢-細節結果 -->
	<div id="search_dcr" class="col-12 m-0 p-1">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-secondary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#search_dcr_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_dcr_open" class="row m-0 collapse">
			<b class="p-0 m-0 lh-1 wlr  bg-secondary text-white"> Result
				detail </b>
			<table
				class=" col m-0 p-0 border border-primary  table table-striped table-hover table-sm table-bordered border-primary table-responsive table-style shadow-sm">
				<thead class="table-primary fixedCt">
					<tr>
						<th class="fixedC1" style="min-width: 40px;">
							<div>
								<button id="exthDetailAll" type="button"
									class="lh-1 col p-1 m-0 btn btn-sm btn-outline-dark">
									<b>M</b>
								</button>
							</div>
						</th>
						<th class="exTheadth d-none" style="min-width: 100px;">N/A</th>
					</tr>
				</thead>
				<tbody class="table-white">
					<tr class="exDetailTbodyTr">
						<th class="fixedC1 exTbodyTh" style="max-width: 40px;">
							<div>
								<input type="checkbox" alt="row_x" title="IKey_GKey"
									class="m-0 form-check-input checkbox_24 border border-dark">
							</div>
						</th>
						<td class="exTbodytd d-none" style="max-width: 100px"></td>
					</tr>

				</tbody>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
	//宣告
	//console.log("other.html(init)");
	other = {
		//資料
		data: {
			marks: {},//有選取的IKeyGKey
			markDetails: {},//有選取的IKeyGKey
			entityFormatJson: {},//查詢格式
			btn_send_auto: null,//自動傳送
			//換頁設置
			searchPageSet: {
				total: 100,//批次數量(1-1000)
				batch: 0,//第幾批次(1-1000)
				pageNew: 1,//單前頁碼(1-50)
				pageSize: 100,//每頁數量(1-20)
				entityJsons: [],//資料
				entityDetailJsons: [],//細節資料
				entityIKey: "",//ID
				entityGKey: "",//GID
				entityDateTime: "",//是時間格式的欄位 
			},
			searchSet: {},
		},
		//方法
		methods: {
			create() {
				//==========================第一次載入==========================
				//Step0.初始化
				console.log("other.html(created)");
				//查詢格式
				other.data.entityFormatJson = JSON.parse(main.resq_data['entityFormatJson']);
				//查詢項目 
				let searchSetJson = JSON.parse(main.resq_data['searchSet']);
				//console.log(searchSetJson);
				//資料內容
				other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
				other.data.searchPageSet.entityDetailJsons = JSON.parse(main.resq_data['entityDetailJson']);
				other.data.entityIKey = main.resq_data['entityIKeyGKey'].split("_")[0];
				other.data.entityGKey = main.resq_data['entityIKeyGKey'].split("_")[1];
				other.data.entityDateTime = main.resq_data['entityDateTime'];
				other.data.searchSet = searchSetJson['searchSet'];
				//按鈕權限?
				let p = $("#nav_functional_unit").attr("alt").split("<_>")[2];
				let ps = Array.from(p);

				if (ps[10] != 1) {//查詢(AR)10
					$("#btn_send").addClass("disabled");
					$("#btn_re_synchronize").addClass("disabled");
				} if (ps[5] != 1) {//修改(S1)5
					$("#btn_agree").addClass("disabled");
				}
				if (ps[4] != 1) {//修改(S2)4
					$("#btn_passAll").addClass("disabled");
				}
				if (ps[3] != 1) {//修改(S3)3
					$("#btn_returnSelect").addClass("disabled");
				}
				if (ps[2] != 1) {//修改(S4)2
					$("#btn_urgency").addClass("disabled");
				}
				if (ps[1] != 1) {//修改(S4)1
					$("#btn_manufacturePass").addClass("disabled");
				}



				//Step1.查詢結果標題-排序
				let resultThead = searchSetJson['resultThead'];
				let resultDetailThead = searchSetJson['resultDetailThead'];
				resultThead = main.methods.orderedSort(resultThead);
				resultDetailThead = main.methods.orderedSort(resultDetailThead);
				//console.log(resultThead);
				//Step2.查詢結果標題-資料
				let check1 = true;
				Object.keys(resultThead).forEach(function (k) {
					//console.log(k + ' - ' + resultThead[k]);
					//複製格式
					let exTheadth = $('#search_cr_open .exTheadth').clone();
					let exTbodytd = $('#search_cr_open .exTbodytd').clone();
					exTheadth.removeClass('exTheadth');
					exTheadth.removeClass('d-none')
					exTheadth.addClass('titTheadth');
					//
					exTbodytd.removeClass('exTbodytd');
					exTbodytd.removeClass('d-none')
					exTbodytd.addClass('valTbodytd');
					exTbodytd.addClass(resultThead[k].cellName);
					//固定第一格式
					if (check1 && resultThead[k].show == 1) {
						check1 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', "40px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', "40px");
					}


					//如果有翻譯
					if (resultThead[k].cellLanguage != '') {
						let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
						exTheadth.text(cellName == "" ? resultThead[k].cellName : cellName);//有可能內容是空的
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
					} else {
						exTheadth.text(resultThead[k].cellName);
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
					}
					//如果隱藏
					if (resultThead[k].show == 0) {
						exTheadth.addClass('d-none');
						exTbodytd.addClass('d-none');
					}
					//添加
					$('#search_cr_open .exTheadth').before(exTheadth);
					$('#search_cr_open .exTbodytd').before(exTbodytd);
				});
				//Step2.查詢結果標題(細節)-資料
				check1 = true;
				let withFixed = 40;
				let fix3 = 1;//固定3格
				if (JSON.stringify(resultDetailThead) == '{}') {
					$('#btn_detail').addClass('disabled');
					$('#search_dcr').addClass('d-none');
				}
				Object.keys(resultDetailThead).forEach(function (k) {
					//console.log(k + ' - ' + resultDetailThead[k]);
					//複製格式
					let exTheadth = $('#search_dcr_open .exTheadth').clone();
					let exTbodytd = $('#search_dcr_open .exTbodytd').clone();
					exTheadth.removeClass('exTheadth');
					exTheadth.removeClass('d-none')
					exTheadth.addClass('titTheadth');
					//
					exTbodytd.removeClass('exTbodytd');
					exTbodytd.removeClass('d-none')
					exTbodytd.addClass('valTbodytd');
					exTbodytd.addClass(resultDetailThead[k].cellName);
					//固定第一格式
					if (check1 && resultDetailThead[k].show == 1) {
						if (fix3 == 3) {
							check1 = false;
						}
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', withFixed + "px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', withFixed + "px");
						withFixed += resultDetailThead[k].width;
						fix3 += 1;
					}

					//如果有翻譯
					if (resultDetailThead[k].cellLanguage != '') {
						let cellName = JSON.parse(resultDetailThead[k].cellLanguage)[$('#menu_login_language').text()];
						exTheadth.text(cellName == "" ? resultDetailThead[k].cellName : cellName);
						exTheadth.css('minWidth', resultDetailThead[k].width + "px");
						exTbodytd.css('maxWidth', resultDetailThead[k].width + "px");
					} else {
						exTheadth.text(resultDetailThead[k].cellName);
						exTheadth.css('minWidth', resultDetailThead[k].width + "px");
						exTbodytd.css('maxWidth', resultDetailThead[k].width + "px");
					}
					//如果隱藏
					if (resultDetailThead[k].show == 0) {
						exTheadth.addClass('d-none');
						exTbodytd.addClass('d-none');
					}
					//添加
					$('#search_dcr_open .exTheadth').before(exTheadth);
					$('#search_dcr_open .exTbodytd').before(exTbodytd);
				});

				//Step3.查詢內容-格式
				for (let b = 1; b <= other.data.searchPageSet.pageSize; b++) {
					let exTbodyTr = $('.exTbodyTr').clone();
					exTbodyTr.removeClass('exTbodyTr');
					exTbodyTr.removeClass('d-none');
					exTbodyTr.addClass('valTbodyTr_' + b);
					exTbodyTr.find('input').attr("alt", "row_" + b);
					$('.exTbodyTr').before(exTbodyTr);
				}
				$('.exTbodyTr').addClass('d-none');

				//Step4.查詢條件
				for (let t = 0; t < searchSetJson['searchSet'].length; t++) {
					let searchSet = searchSetJson['searchSet'][t];
					let searchTextEx = "";
					let searchSelectEx = "";
					let selectEx = "";
					//不顯示
					if (!searchSet['show']) {
						continue;
					}
					if (searchSet['type'] != 'select') {
						//一般文字
						searchTextEx = $('.searchTextEx').clone();
						searchTextEx.removeClass("searchTextEx");
						searchTextEx.removeClass("col-md-1");
						searchTextEx.removeClass("d-none");
						searchTextEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchTextEx.find('input').attr("id", searchSet['searchName']);
						searchTextEx.find('input').attr("name", searchSet['searchName']);
						searchTextEx.find('input').attr("placeholder", searchSet['placeholder']);
						searchTextEx.find('input').addClass("searchVal");
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchTextEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchTextEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
					} else {
						//選擇選單
						searchSelectEx = $('.searchSelectEx').clone();
						searchSelectEx.removeClass("searchSelectEx");
						searchSelectEx.removeClass("col-md-1");
						searchSelectEx.removeClass("d-none");
						searchSelectEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchSelectEx.find('select').attr("id", searchSet['searchName']);
						searchSelectEx.find('select').attr("name", searchSet['searchName']);
						searchSelectEx.find('select').addClass("searchVal");
						//查詢欄位
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									let cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchSelectEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchSelectEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
						//選項
						for (let s = 0; s < searchSet['select'].length; s++) {
							let key = searchSet['select'][s].split("_")[0];
							let val = searchSet['select'][s].split("_")[1];
							selectEx = searchSelectEx.find('.selectEx').clone();
							selectEx.removeClass("selectEx");
							selectEx.removeAttr("selected");
							selectEx.text(key);
							selectEx.val(val);
							selectEx.appendTo(searchSelectEx.find('select'));
						}
					}
					switch (searchSet['type']) {
						case "select":
							searchSelectEx.appendTo('#searchItem');
							break;
						case "text":
							searchTextEx.appendTo('#searchItem');
							break;
						case "time":
							searchTextEx.find('input').addClass('datetimepicker_time');
							searchTextEx.appendTo('#searchItem');
							break;
						case "datetime":
							searchTextEx.find('input').addClass('datetimepicker_date');
							searchTextEx.appendTo('#searchItem');
							break;
					}
				}
				//時間格式
				other.methods.datetimepickerDate();
				//Step5.帶入資料
				other.methods.otherReLoad();

				//==========================監聽==========================
				//監聽-選取資料
				$(document).off("change", "#search_c #search_cr_open .exTbodyTh input");
				$(document).on("change", "#search_c #search_cr_open .exTbodyTh input", function (event) {
					console.log("search_cr_open");
					//一般資料
					let Ikey_Gkey = event.target.title;
					let check = event.target.checked;
					//細節細項
					let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
					let entityIKey = other.data.entityIKey;//IKey
					let entityGKey = other.data.entityGKey;//GKey
					let detailGKey = Ikey_Gkey.split("_")[1];
					//標記-選取|解除
					if (check == true) {
						other.data.marks[Ikey_Gkey] = true;
						//console.log(entityDetailJsons);	
						//細節
						for (let k in entityDetailJsons) {
							if (entityDetailJsons[k][entityGKey] + "" == detailGKey) {
								let markDetail = entityDetailJsons[k][entityIKey] + "_" + entityDetailJsons[k][entityGKey];
								other.data.markDetails[markDetail] = true;
								continue;
							};
						}
					} else {
						for (let k in other.data.marks) {
							if (k == Ikey_Gkey) {
								delete other.data.marks[k];
								//細節
								let markDetailsRemove = "_" + Ikey_Gkey.split("_")[1];
								for (let s in other.data.markDetails) {
									if (s.indexOf(markDetailsRemove) >= 0) {//取得群組尾數
										delete other.data.markDetails[s];
										continue;
									};
								}
								break;
							};
						}
					}
					//console.log(other.data.marks);	
					//console.log(other.data.markDetails);
				});
				//監聽-選取資料
				$(document).off("change", "#search_c #search_dcr_open .exTbodyTh input");
				$(document).on("change", "#search_c #search_dcr_open .exTbodyTh input", function (event) {
					console.log("search_dcr_open");
					let Ikey_Gkey = event.target.title;
					let check = event.target.checked;
					let mark = {};
					//標記-選取|解除
					if (check == true) {
						other.data.markDetails[Ikey_Gkey] = true;
					} else {
						for (let k in other.data.markDetails) {
							if (k == Ikey_Gkey) {
								delete other.data.markDetails[k];
								break;
							};
						}
					}
					//console.log(other.data.markDetails);				
				});
				//監聽-全選資料
				$(document).off("click", "#search_c #exthAll");
				$(document).on("click", "#search_c #exthAll", function (event) {
					//都有勾選?
					let clickAll = true;
					$("#search_cr_open .exTbodyTh").each(function () {
						if ($(this).find("input").attr("disabled") != "disabled" && $(this).find("input").prop("checked") == false) {
							$(this).find("input").trigger("click");
							clickAll = false;
						}
					});
					//全部取消?
					if (clickAll) {
						$("#search_cr_open .exTbodyTh").find("input").trigger("click");
					}
				});
				//監聽-全選資料
				$(document).off("click", "#search_c #exthDetailAll");
				$(document).on("click", "#search_c #exthDetailAll", function (event) {
					//都有勾選?
					let clickAll = true;
					$("#search_dcr_open .exTbodyTh").each(function () {
						if ($(this).find("input").attr("disabled") != "disabled" && $(this).find("input").prop("checked") == false) {
							$(this).find("input").trigger("click");
							clickAll = false;
						}
					});
					//全部取消?
					if (clickAll) {
						$("#search_dcr_open .exTbodyTh").find("input").trigger("click");
					}
				});
				//監聽-細節
				$(document).off("click", "#search_c #btn_detail");
				$(document).on("click", "#search_c #btn_detail", function (event) {
					console.log("btn_detail");
					let marks = other.data.marks;
					let markDetails = other.data.markDetails;
					//觸發?
					$('#search_cr i').trigger('click');
					if (!$('#search_dcr_open').hasClass('show')) {
						$('#search_dcr i').trigger('click');
					}
					//有標記?
					if (marks != null && other.data.searchPageSet.entityDetailJsons != null) {
						let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
						let entityIKey = other.data.entityIKey;
						let entityGKey = other.data.entityGKey;
						let entityDateTime = other.data.entityDateTime;
						//console.log(entityDetailJsons);
						//Step1.查詢細節內容-格式
						$(".valTbodyTrD").remove();
						$('#search_dcr_open tbody td').removeClass('bg-warning');
						for (let k in other.data.marks) {
							for (let d = 0; d < entityDetailJsons.length; d++) {
								if (entityDetailJsons[d][entityGKey] == k.split("_")[1]) {
									//=======格式=======
									let exTbodyTr = $('.exDetailTbodyTr').clone();
									exTbodyTr.removeClass('exDetailTbodyTr');
									exTbodyTr.removeClass('d-none');
									exTbodyTr.addClass('valTbodyDetailTr_' + (d + 1));
									exTbodyTr.addClass('valTbodyTrD');
									exTbodyTr.find('input').attr("alt", "row_" + (d + 1));
									//=======資料=======
									let entity = entityDetailJsons[d];//
									let iKey = "", gKey = "";
									let valTrNb = d + 1;
									Object.keys(entity).forEach(function (s) {
										//是否IKEY?
										if (entityIKey == s) {iKey = entity[s];}
										//是否GKEY?
										if (entityGKey == s) {gKey = entity[s];}
										exTbodyTr.find('input').removeAttr("disabled");
										exTbodyTr.find('input').attr("title", iKey + "_" + gKey);
										//是否時間格式?
										if (entityDateTime.indexOf(s) >= 0) {
											let dF = new Date(entity[s]);
											let dateF = dF.getFullYear() + "-";
											dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
											dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
											dateF += (dF.getHours() < 10 ? "0" + dF.getHours() : dF.getHours()) + ":";
											dateF += (dF.getMinutes() < 10 ? "0" + dF.getMinutes() : dF.getMinutes()) + ":";
											dateF += (dF.getSeconds() < 10 ? "0" + dF.getSeconds() : dF.getSeconds());
											exTbodyTr.find('.' + s).text(dateF);
										} else {
											exTbodyTr.find('.' + s).text(entity[s]);
											//特別標記
											if (s == 'waspngqty' && entity['waspngqty'] != entity['waspnqty']) {
												exTbodyTr.find('.' + s).addClass('bg-warning');
											}
											//集結?
											if (s == 'wasfucheckin' && !entity['wasfucheckin']) {
												exTbodyTr.find('.' + s).addClass('bg-warning');
											}
										}
									});
									//marks標記?	->帶入[mark]
									if (other.data.markDetails[iKey + "_" + gKey] != null) {
										exTbodyTr.find('input').prop("checked", true);
									}
									$('.exDetailTbodyTr').before(exTbodyTr);
								} else {
									continue;
								}

							}
						}
						$('.exDetailTbodyTr').addClass('d-none');
					}
				});
				//監聽-同意
				$(document).off("click", "#search_c #btn_agree");
				$(document).on("click", "#search_c #btn_agree", function (event) {
					console.log("btn_agree");
					other.methods.searchToModify("btn_agree");
				});
				//監聽-略過
				$(document).off("click", "#search_c #btn_passAll");
				$(document).on("click", "#search_c #btn_passAll", function (event) {
					console.log("btn_passAll");
					other.methods.searchToModify("btn_passAll");
				});
				//監聽-歸還
				$(document).off("click", "#search_c #btn_returnSelect");
				$(document).on("click", "#search_c #btn_returnSelect", function (event) {
					console.log("btn_returnSelect");
					other.methods.searchToModify("btn_returnSelect");
				});
				//監聽-急迫
				$(document).off("click", "#search_c #btn_urgency");
				$(document).on("click", "#search_c #btn_urgency", function (event) {
					console.log("btn_urgency");
					other.methods.searchToModify("btn_urgency");
				});
				//監聽-合併
				$(document).off("click", "#search_c #btn_merge");
				$(document).on("click", "#search_c #btn_merge", function (event) {
					console.log("btn_merge");
					other.methods.searchToModify("btn_merge");
				});
				//監聽-產險配料清點PASS
				$(document).off("click", "#search_c #btn_manufacturePass");
				$(document).on("click", "#search_c #btn_manufacturePass", function (event) {
					console.log("btn_manufacturePass");
					other.methods.searchToModify("btn_manufacturePass");
				});


				//監聽-標記移除
				$(document).off("click", "#search_c #btn_markCancel");
				$(document).on("click", "#search_c #btn_markCancel", function (event) {
					console.log("btn_markCancel");
					other.data.marks = [];
					other.data.markDetails = [];
					$('.exTbodyTh input').prop("checked", false);
					//移除資料
					$('#search_cr_open .wasclasssn').removeClass('text-primary');
					$('#search_cr_open .wasclasssn').removeClass('text-success');
					$('#search_cr_open .wasclasssn').removeClass('text-danger');
					$('#search_cr_open .wasclasssn').removeClass('text-warning');
					$('#search_cr_open .wasclasssn').removeClass('text-info');
					$('#search_cr_open .wasclasssn').removeClass('bg-info');


					$("#btn_send").trigger("click");

				});
				//監聽-打印
				$(document).off("click", "#search_c #btn_printerForm");
				$(document).on("click", "#search_c #btn_printerForm", function (event) {
					console.log("btn_printerForm");
					other.methods.searchToPrint(null);
					other.methods.searchToModify("btn_printerForm");

				});
				//監聽-修改傳送
				$(document).off("click", "#search_c #btn_confirm");
				$(document).on("click", "#search_c #btn_confirm", function (event) {
					console.log("btn_confirm");
					other.methods.confirmSend();

				});
				//監聽-再次同步單據
				$(document).off("click", "#search_c #btn_re_synchronize");
				$(document).on("click", "#search_c #btn_re_synchronize", function (event) {
					console.log("btn_re_synchronize");
					other.methods.confirmSendReSynchronize();

				});
				//監聽-比對
				$(document).off("click", "#search_c #btn_compare");
				$(document).on("click", "#search_c #btn_compare", function (event) {
					console.log("btn_compare");
					other.methods.searchToCompare(null);

				});

				//監聽-查詢
				$(document).off("click", "#search_c #btn_send");
				$(document).on("click", "#search_c #btn_send", function (event) {
					console.log("btn_send");
					other.methods.searchSend(0);

					// 是否啟用自動查詢
					if ($("#search_c #btn_send_auto").prop("checked")) {
						console.log("start auto send (30s)");
						// ✅ 這一輪 timeout 已執行，先釋放，才能排下一輪
						clearTimeout(other.data.btn_send_auto);
						other.data.btn_send_auto = null;
						other.data.btn_send_auto = setTimeout(function autoSend() {
							// 若 auto 已被取消，就不再觸發
							if (!$("#search_c #btn_send_auto").prop("checked")) return;
							// 觸發下一輪（會再安排下一個 30s）
							$("#search_c #btn_send").trigger("click");
						}, 30000);
					} else {
						// ❌ 取消自動查詢
						if (other.data.btn_send_auto !== null) {
							console.log("stop auto send");
							clearTimeout(other.data.btn_send_auto);
							other.data.btn_send_auto = null;
						}
					}
				});
				//監聽-查詢(促發)
				$(document).off("keyup", "#searchItem input");
				$(document).on("keyup", "#searchItem input", function (e) {
					if (e.key === 'Enter' || e.keyCode === 13) {
						$(e.currentTarget).select();
						$("#search_c #btn_send").trigger("click");
					}
				});
				//監聽-清除查詢
				$(document).off("click", "#search_c #btn_clearAll");
				$(document).on("click", "#search_c #btn_clearAll", function (event) {
					console.log("btn_clearAll");
					$("#searchItem input").val("");
					$("#searchItem select").val("");

				});

				//時間格式
				other.methods.datetimepickerDate();

			},
			datetimepickerDate() {
				//日期時間格式
				$('#search_c .datetimepicker').remove();
				$('#search_c .datetimepicker_date:not(:disabled)').datetimepicker({
					format: 'yyyy-mm-dd',
					pickerPosition: 'bottom-right',
					startView: 2,    // 2 = month view（年/月/日）
				    minView: 2,      // 2 = 最小停在「日」
				    autoclose: true,
				    endDate: '+1d',
				    datesDisabled: '+1d',
				    todayBtn: true,
				    bootcssVer: 5
					//......可以同上項目代碼自定義設置
				});
				$('#search_c .datetimepicker_datetime:not(:disabled)').datetimepicker({
					format: 'yyyy-mm-dd hh:ii:00',
					pickerPosition: 'bottom-right',
					//minView:1,
					// hoursDisabled: [00, 1, 2, 3, 4, 5, 6],
					minuteStep: 30,
					autoclose: true,
					endDate: '+1d',
					datesDisabled: '+1d',
					todayBtn: true,
					bootcssVer: 5,
					//......可以同上項目代碼自定義設置
				});
				//時間格式
				$('#search_c .datetimepicker_time:not(:disabled)').datetimepicker({
					format: 'hh:ii',
					startView: 1,
					minuteStep: 30,
					pickDate: false,
					autoclose: true,
					timeFormat: 'hh:mm',
				});
			},
			//==========================修改資料==========================
			searchToModify(order) {
				//是否marks?markDetails?
				let marks = other.data.marks;
				//console.log(JSON.stringify(marks)); 
				if (JSON.stringify(marks) == "{}") {
					return null;
				}
				//Data
				let timeBasedCode = other.methods.generateTimeBasedCode();
				$('#search_cr_open tbody tr').each(function () {
					if ($('.' + this.className + ' input').prop("checked")) {
						//console.log(this.className+" "+ $('.'+this.className+' input').prop("checked"));
						$('.' + this.className + ' .wasclasssn').removeClass('text-info');
						$('.' + this.className + ' .wasclasssn').removeClass('text-primary');
						$('.' + this.className + ' .wasclasssn').removeClass('text-success');
						$('.' + this.className + ' .wasclasssn').removeClass('text-warning');
						$('#search_dcr_open .wasclasssn').removeClass('text-danger');
						$('#search_dcr_open .wasclasssn').removeClass('text-success');
						switch (order) {
							case "btn_agree":
								//異動資料
								$('.' + this.className + ' .wascuser').text($('#menu_login_name').text());
								//標記顏色
								$('.' + this.className + ' .wasclasssn').addClass('text-primary');
								break;
							case "btn_passAll":
								//異動資料
								//$('.' + this.className + ' .wascuser').text($('#menu_login_name').text());
								//$('.' + this.className + ' .wasfuser').text($('#menu_login_name').text());
								//標記顏色
								//$('.' + this.className + ' .wasclasssn').addClass('text-success');
								//標記顏色
								$('#search_dcr_open tbody tr').each(function () {
									if ($(this).find('input').prop("checked")) {
										//console.log(this);
										$(this).find('.wasclasssn').addClass('text-success');
									}
								});
								break;
							case "btn_urgency":
								//異動資料
								$('.' + this.className + ' .wasstatus').text("1");
								//標記顏色
								$('.' + this.className + ' .wasclasssn').addClass('text-warning');
								break;
							case "btn_merge":
								//異動資料
								$('.' + this.className + ' .waspmerge').text(timeBasedCode);
								$('.' + this.className + ' .wasumerge').text($('#menu_login_name').text());
								//標記顏色
								$('.' + this.className + ' .wasclasssn').addClass('text-success');
								break;	
								
							case "btn_manufacturePass":
								//異動資料
								$('.' + this.className + ' .wassmuser').text($('#menu_login_name').text());
								//標記顏色
								$('.' + this.className + ' .wasclasssn').addClass('text-info');
								break;
							case "btn_returnSelect":
								//標記顏色 
								//$('.' + this.className + ' .wasstatus').text("1");
								//標記顏色
								$('#search_dcr_open tbody tr').each(function () {
									if ($(this).find('input').prop("checked")) {
										//console.log(this);
										$(this).find('.wasclasssn').addClass('text-danger');
									}
								});
								break;
							case "btn_printerForm":
								//標記顏色
								$('.' + this.className + ' .wasclasssn').addClass('bg-info');
								break;
						}
					}
				});
			},
			searchToCompare(order) {
				//比對資料 
				//是否marks?markDetails?
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
				let marks = other.data.marks;
				let markDetails = other.data.markDetails;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;
				let dataHeader = [];
				let dataBody = [];
				console.log(JSON.stringify(marks));
				if (JSON.stringify(marks) == "{}" && JSON.stringify(markDetails) == "{}") {
					return null;
				}
				//Data
				Object.keys(marks).forEach(function (ik) {
					let ikey = ik.split("_")[0];
					let gkey = ik.split("_")[1];
					for (let en = 0; en < entityJsons.length; en++) {
						if (entityJsons[en][entityIKey] == ikey) {
							entityJsons[en]['compare_gid_id'] = gkey+"_"+ikey;
							dataHeader.push(entityJsons[en]);
						}
					}
				});
				//Details
				Object.keys(markDetails).forEach(function (dk) {
					let ikey = dk.split("_")[0];
					let gkey = dk.split("_")[1];
					for (let en = 0; en < entityDetailJsons.length; en++) {
						if (entityDetailJsons[en][entityIKey] == ikey) {
							entityDetailJsons[en]['compare_gid_id'] = gkey+"_"+ikey;
							dataBody.push(entityDetailJsons[en]);
						}
					}
				});
				compare.methods.compare(dataHeader, dataBody, entityDateTime, entityIKey, entityGKey);
			},
			searchToPrint(order) {
				//比對資料 
				//是否marks?markDetails?
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
				let marks = other.data.marks;
				let markDetails = other.data.markDetails;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;
				let dataHeader = [];
				let dataBody = [];
				console.log(JSON.stringify(marks));
				if (JSON.stringify(marks) == "{}" && JSON.stringify(markDetails) == "{}") {
					return null;
				}
				//Data
				Object.keys(marks).forEach(function (ik) {
					let ikey = ik.split("_")[0];
					let gkey = ik.split("_")[1];
					for (let en = 0; en < entityJsons.length; en++) {
						if (entityJsons[en][entityIKey] == ikey) {
							dataHeader.push(entityJsons[en]);
						}
					}
				});
				//Details
				Object.keys(markDetails).forEach(function (dk) {
					let ikey = dk.split("_")[0];
					let gkey = dk.split("_")[1];
					for (let en = 0; en < entityDetailJsons.length; en++) {
						if (entityDetailJsons[en][entityIKey] == ikey) {
							//而外檢查是否勾選0項目
							if (entityDetailJsons[en]["waspnqty"] > 0) {
								dataBody.push(entityDetailJsons[en]);
							} else if (!$("#btn_only_have_qty").prop("checked")) {
								dataBody.push(entityDetailJsons[en]);
							}
						}
					}
				});
				//打印資料
				print.methods.printPrepare(dataHeader, dataBody, entityIKey, entityGKey);
			},

			//==========================傳送資料==========================
			confirmSend() {
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityDetailJsons = other.data.searchPageSet.entityDetailJsons;
				let markDetails = other.data.markDetails;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;

				let dataHeaderPrint = [];
				let dataHeaderAgree = [];
				let dataHeaderPassAll = [];
				let dataHeaderUrgency = [];
				let dataHeaderMerge = [];
				let dataHeaderReturnAll = [];
				let dataHeaderManufacturePass = [];
				

				//確認選取
				$('#search_cr_open tbody tr').each(function () {
					//標記:以打印
					if ($('.' + this.className + ' .wasclasssn').hasClass('bg-info')) {
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderPrint.push(entityJosn);
					}
					//同意:核准人
					if ($('.' + this.className + ' .wasclasssn').hasClass('text-primary')) {
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderAgree.push(entityJosn);
					}
					//登記:急單
					if ($('.' + this.className + ' .wasclasssn').hasClass('text-warning')) {
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderUrgency.push(entityJosn);

					}
					//登記:配料Merge
					if ($('.' + this.className + ' .wasclasssn').hasClass('text-success')) {
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderMerge.push(entityJosn);
					}
					//登記:配料清點人Pass
					if ($('.' + this.className + ' .wasclasssn').hasClass('text-info')) {
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderManufacturePass.push(entityJosn);
					}
					
				});
				$('#search_dcr_open tbody tr').each(function (index) {
					//登記:返回
					if ($(this).find('input').prop("checked") && $(this).find('.wasclasssn').hasClass('text-danger')) {
						//每個欄位
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderReturnAll.push(entityJosn);
					}
					//同意:略過此單據 or 單項目
					if ($(this).find('input').prop("checked") && $(this).find('.wasclasssn').hasClass('text-success')) {
						//每個欄位
						let entityJosn = {};
						$(this).find('.valTbodytd').each(function (index) {
							let val = $(this).text().replaceAll('\t').replaceAll('\n').replaceAll('\f').replaceAll('\r');
							let name = $(this).attr('class').split(' ')[1];
							//可能是時間格式
							if (entityDateTime.indexOf(name) >= 0) {
								val = new Date(val).getTime();
							}
							entityJosn[name] = val;
						});
						dataHeaderPassAll.push(entityJosn);
					}
				});

				console.log(dataHeaderAgree);
				console.log(dataHeaderPassAll);
				console.log(dataHeaderReturnAll);
				console.log(dataHeaderUrgency);
				console.log(dataHeaderPrint);
				console.log(dataHeaderManufacturePass);




				//移除
				$('#search_cr_open .valTbodytd').
					removeClass('text-success').removeClass('text-primary').
					removeClass('text-warning').removeClass('text-danger').
					removeClass('text-info').removeClass('bg-info');

				let action = "";
				let type = "PUT";
				let data = null;
				let req_data = {};
				let searchPageSet = {};
				if (dataHeaderAgree.length > 0) {
					action = "S1";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderAgree);
					data['entityDetailJson'] = JSON.stringify('{}');
				} else if (dataHeaderPassAll.length > 0) {
					action = "S2";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderPassAll);
					data['entityDetailJson'] = JSON.stringify('{}');
				} else if (dataHeaderReturnAll.length > 0) {
					action = "S3";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderReturnAll);
					data['entityDetailJson'] = JSON.stringify('{}');
				} else if (dataHeaderUrgency.length > 0) {
					action = "S4";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderUrgency);
					data['entityDetailJson'] = JSON.stringify('{}');
				}else if (dataHeaderMerge.length > 0) {
					action = "SS4";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderMerge);
					data['entityDetailJson'] = JSON.stringify('{}');
				} else if (dataHeaderManufacturePass.length > 0) {
					action = "S5";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderManufacturePass);
					data['entityDetailJson'] = JSON.stringify('{}');
				} else if (dataHeaderPrint.length > 0) {
					action = "SS1";
					//傳送....
					data = {};
					data['entityJson'] = JSON.stringify(dataHeaderPrint);
					data['entityDetailJson'] = JSON.stringify('{}');
				}

				if (data != null) {
					//包裝
					data['callBackFunction'] = "other_modify";
					req_data['data'] = data;
					req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil." + action;//AC/AD....
					req_data['type'] = type;//POST/PUT/DELETE...
					main.methods.ajaxSend(req_data, true);

				}
				return false;
			},
			//特殊傳送->同步資料
			confirmSendReSynchronize() {
				let action = "ARE";
				let type = "POST";
				let data = null;
				let req_data = {};
				let searchPageSet = {};

				//傳送....
				data = {};
				data['entityJson'] = JSON.stringify('{}');
				data['entityDetailJson'] = JSON.stringify('{}');

				//包裝
				data['callBackFunction'] = "other_modify";
				req_data['data'] = data;
				req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil." + action;//AC/AD....
				req_data['type'] = type;//POST/PUT/DELETE...
				main.methods.ajaxSend(req_data, true);
			},
			//修改後回傳
			otherModifyReturn() {
				other.methods.searchSend(0);
			},
			searchSend(batch) {
				let entityJson = other.data.entityFormatJson;//格式
				let data = {};
				let req_data = {};
				let searchPageSet = {};
				//移除除標記
				$('#search_cr_open .wasclasssn').removeClass('text-primary');
				$('#search_cr_open .wasclasssn').removeClass('text-success');
				$('#search_cr_open .wasclasssn').removeClass('text-danger');
				$('#search_cr_open .wasclasssn').removeClass('text-warning');
				$('#search_cr_open .wasclasssn').removeClass('text-info');
				$('#search_cr_open .wasclasssn').removeClass('bg-info');


				//查詢
				$("#searchItem .searchVal").each(function (index) {
					//console.log(index+" : "+$(this).attr("id")+" : "+$(this).val());
					if ($(this).hasClass('datetimepicker_date') && $(this).val() != "") {
						entityJson[$(this).attr("id")] = new Date($(this).val()).getTime();
					} else {
						entityJson[$(this).attr("id")] = $(this).val() == "" ? null : $(this).val();
					}
				});
				data['entityJson'] = JSON.stringify(entityJson);
				//換頁
				searchPageSet['total'] = other.data.searchPageSet.total;//批次數量
				searchPageSet['batch'] = batch;//第幾批次
				data['searchPageSet'] = JSON.stringify(searchPageSet);
				data['callBackFunction'] = "other_search";
				//包裝
				req_data['data'] = data;
				req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil.AR";
				req_data['type'] = "POST";
				main.methods.ajaxSend(req_data, true);
				//時間格式
				other.methods.datetimepickerDate();
			},
			//==========================資料載入==========================
			otherReLoad() {
				//還原
				$('.valTbodytd').text("");
				$('.exTbodyTh input').attr("disabled", "disabled");
				$('.exTbodyTh input').attr("title", "IKey_GKey");
				$('.exTbodyTh input').prop("checked", false);
				$('#search_cr_open tbody td').removeClass('bg-warning');
				//版面預設
				if ($('#search_dcr_open').hasClass('show')) {
					$('#search_dcr .btn-outline-white').trigger('click');
				}
				if (!$('#search_cr_open').hasClass('show')) {
					$('#search_cr .btn-outline-white').trigger('click');
				}
				$('#search_cr_open table,#search_dcr_open table').animate({scrollTop: 0}, 'slow');
				//Step5.帶入資料
				let marks = other.data.marks;
				let entityJsons = other.data.searchPageSet.entityJsons;
				let entityIKey = other.data.entityIKey;
				let entityGKey = other.data.entityGKey;
				let entityDateTime = other.data.entityDateTime;
				let pageSize = other.data.searchPageSet.pageSize;//每頁數量(1-20)
				let pageNew = other.data.searchPageSet.pageNew - 1;//單前頁碼(1-50)
				let pageSN = pageSize * pageNew;//目前分頁->資料戳記
				for (let x = 0; x < pageSize; x++) {
					//筆數還夠
					if (pageSN + x < entityJsons.length) {
						let entity = entityJsons[pageSN + x];//((目前頁碼-1)*每頁數量)+x
						let iKey = "";
						let gKey = "";
						
						Object.keys(entity).forEach(function (k) {
							//欄位計數
							let valTrNb = x + 1;
							let valTbodyTr_ = $('.valTbodyTr_' + valTrNb);
							let valTbodyTr_input = valTbodyTr_.find(' th input');
							let valTbodyTr_k = valTbodyTr_.find( ' .' + k);
							let entity_k = entity[k];
							valTbodyTr_input.removeAttr("disabled");
							//是否IKEY?
							if (entityIKey == k) {iKey = entity_k;}
							//是否GKEY?
							if (entityGKey == k) {gKey = entity_k;}
							//是否時間格式?
							if (entityDateTime.indexOf(k) >= 0) {
								let dF = new Date(entity_k);
								let dateF = dF.getFullYear() + "-";
								dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
								dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
								dateF += (dF.getHours() < 10 ? "0" + dF.getHours() : dF.getHours()) + ":";
								dateF += (dF.getMinutes() < 10 ? "0" + dF.getMinutes() : dF.getMinutes()) + ":";
								dateF += (dF.getSeconds() < 10 ? "0" + dF.getSeconds() : dF.getSeconds());
								valTbodyTr_k.text(dateF);
							} else {
								valTbodyTr_k.text(entity_k);
							}

							//marks標記?
							valTbodyTr_input.attr("title", iKey + "_" + gKey);
							//帶入
							for (let m = 0; m < marks.length; m++) {
								if (marks[m].Ikey_Gkey == iKey + "_" + gKey) {
									valTbodyTr_input.prop("checked", true);
									break;
								}
							}
							//打印
							if (k == "waspalready" && entity_k == "未打印") {
								valTbodyTr_k.addClass("bg-warning");
							}
							//完成?
							if (k == "wasschedule" && entity_k.split(" / ")[0] != entity_k.split(" / ")[1]) {
								valTbodyTr_k.addClass("bg-warning");
							}
							if (k == "wascischedule" && entity_k.split(" / ")[0] != entity_k.split(" / ")[1]) {
								valTbodyTr_k.addClass("bg-warning");
							}

						});
					}
				}
			},
			/**
			 * 取得 年月日時分秒 轉換 36進制 (對應後端 Java timeTo36Encoder)
			 * 範例結果：A09Z21
			 * @returns {string} 6碼大寫字串
			 */
			generateTimeBasedCode() {
			    const now = new Date();

			    // 1. 取得時間部分並格式化為 MMddHHmmss (與 Java 邏輯一致)
			    // paddingStart 確保月份、日期等不足兩位時補 0
			    const month = String(now.getMonth() + 1).padStart(2, '0');
			    const day = String(now.getDate()).padStart(2, '0');
			    const hours = String(now.getHours()).padStart(2, '0');
			    const minutes = String(now.getMinutes()).padStart(2, '0');
			    const seconds = String(now.getSeconds()).padStart(2, '0');

			    // 組合數字字串，例如 "0119164010"
			    const timeString = month + day + hours + minutes + seconds;
			    
			    // 2. 轉換為 10 進制數字後，再轉為 36 進制
			    // parseInt 將字串轉為數字，toString(36) 執行進制轉換
			    let base36Code = parseInt(timeString, 10).toString(36).toUpperCase();

			    // 3. 確保補足 6 碼（不足前面補 0）
			    return base36Code.padStart(6, '0');
			},
			//==========================回傳接收==========================
			otherReturn() {
				//查詢回傳
				console.log("searchReturn");
				//Step4.分頁歸位
				if (main.resq_data['entityJson'].length > 0) {
					let searchPageSet = JSON.parse(main.resq_data['searchPageSet']);
					other.data.searchPageSet.total = searchPageSet['total'];
					other.data.searchPageSet.batch = searchPageSet['batch'];
					other.data.searchPageSet.pageNew = 1; //單前頁碼(1-50)
					other.data.marks = {};//有選取的IKeyGKey
					other.data.markDetails = {};//有選取的IKeyGKey
					//Step5.帶入資料
					if (main.resq_data['entityJson'] != "") {
						other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
						other.methods.otherReLoad();
					}
					if (main.resq_data['entityDetailJson'] != "") {
						other.data.searchPageSet.entityDetailJsons = JSON.parse(main.resq_data['entityDetailJson']);
					}
				}
			},
			//==========================初始化==========================
			destroy() {
				//銷毀
				clearTimeout(other.data.btn_send_auto);
				$(document).off("click", "#search_c #btn_clearAll");
				$(document).off("keyup", "#searchItem input");
				$(document).off("click", "#search_c #btn_send");
				$(document).off("click", "#search_c #btn_printerForm");
				$(document).off("click", "#search_c #btn_markCancel");
				$(document).off("click", "#search_c #btn_re_synchronize");

				
				$(document).off("click", "#search_c #btn_merge");
				$(document).off("click", "#search_c #btn_urgency");
				$(document).off("click", "#search_c #btn_returnAll");
				$(document).off("click", "#search_c #btn_passAll");
				$(document).off("click", "#search_c #btn_agree");
				$(document).off("click", "#search_c #btn_detail");
				$(document).off("click", "#search_c #exthDetailAll");
				$(document).off("click", "#search_c #exthAll");
				$(document).off("change", "#search_c #search_dcr_open .exTbodyTh input");
				$(document).off("change", "#search_c #search_cr_open .exTbodyTh input");
				console.log("other.html(destroy)");
			},
		},
	};
</script>