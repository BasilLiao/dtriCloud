<style>
	/*Table 寬度滾動*/
	#search_c .table-responsive {
		display: block;
		width: 100%;
		overflow-x: auto;
	}

	/*Table 自動隱藏*/
	#search_c .table-responsive th {
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
	}

	#search_c .table-responsive td {
		text-overflow: ellipsis;
		overflow: hidden;
	}

	/*Table 表格固定*/
	#search_c .fixedC1 {
		left: 0px;
		position: sticky;
	}

	#search_c .fixedCt {
		position: sticky;
		top: 0px;
		z-index: 5;
	}

	/*Table 每隔表格內_框線*/
	#search_c .table-bordered td,
	#search_c .table-bordered th {
		border: 1px solid #1b76fd;
		padding: 2px;
	}

	/*Table 查詢框 表格外框線*/
	#search_c #search_cr table {
		max-height: 75vh;
		min-height: 200px;
		border-collapse: separate;
		border-spacing: 0px;
	}

	/*Table 編輯框*/
	#search_c_modify table {
		border-collapse: separate;
		border-spacing: 0px;
	}

	/*Table 表格外框線*/
	#search_c #search_dcr table {
		max-height: 570px;
		border-collapse: separate;
		border-spacing: 0px;
	}

	/*Table 表格內 背景色*/
	#search_c .table-white {
		--bs-table-bg: #fff;
	}

	/*覆寫換色*/
	.table-hover>tbody>tr:hover>* {
		--bs-table-accent-bg: #0d6efd40;
		color: var(--bs-table-hover-color);
	}

	/*標題色彩*/
	#search_c .title_color {
		background-color: #cfe2ff;
	}

	/*直立式呈現邊字*/
	#search_c .wlr {
		writing-mode: vertical-lr;
		width: 20px;
	}

	/*checkbox_24*/
	#search_c .checkbox_24 {
		width: 24px;
		height: 24px;
	}

	#search_c .checkbox_20 {
		width: 20px;
		height: 20px;
	}

	#search_c .checkbox_16 {
		width: 16px;
		height: 16px;
	}

	/**指定靠左*/
	.sonb,
	.sopnb,
	.sopname,
	.sopspecifications,
	.soscstatus,
	.somcstatus,
	.souname {
		text-align: left !important;
	}

	.noteShow {
		line-height: 16px;
		font-size: 14px;
	}
</style>
<div id="search_c" class="row p-0 m-0">
	<!-- 查詢面板 -->
	<div id="search_c_item" class="col-12 p-1">
		<div class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-success text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square" data-bs-toggle="collapse"
				data-bs-target="#search_c_item_open" aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div class="row m-0 collapse show" id="search_c_item_open">
			<b class="p-0 m-0 lh-1 wlr bg-success text-white"> Search </b>
			<div id="searchItem" class="col border border-primary  row m-0 p-0 shadow-sm">
				<div class="col-6 searchTextEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search1</div>
						<div class="p-1">
							<input class="col-12 m-0 p-1 border border-dark form-control" type=text id="ex_id"
								name="ex_name" placeholder="Ex:123" autofocus>
						</div>
					</div>
				</div>
				<div class="col-6 searchSelectEx col-md-1 p-1 d-none">
					<div class=" border border-secondary rounded">
						<div class="searchTitle title_color fw-bolder rounded-top">Search2</div>
						<div class="p-1">
							<select class="col-12 m-0 p-1 border border-dark form-select" id="ex_id2" name="ex_name2">
								<option class="selectEx" value="" selected="selected">select(請選擇)</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 控制面板 -->
	<div id="search_c_controller" class="col-12 p-1 ">
		<div class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-primary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square" data-bs-toggle="collapse"
				data-bs-target="#search_c_controller_open" aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_c_controller_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-primary text-white"> Console </b>
			<div class="col border border-primary row m-0 p-0 shadow-sm justify-content-between">
				<div class="col-12 col-lg-5 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Execution</div>
						<div class="row m-0">
							<!--生管編輯-->
							<button id="btn_pc" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-secondary disabled">
								<b>Production<br>control(S1)
								</b>
							</button>
							<!--物控編輯-->
							<button id="btn_mc" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success disabled">
								<b>Material<br>control(S2)
								</b>
							</button>
							<!--倉儲編輯-->
							<button id="btn_wm" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-info disabled">
								<b>Warehouse<br>Management(S3)
								</b>
							</button>
							<!--產線編輯-->
							<button id="btn_pl" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-primary disabled">
								<b>Production<br>line(S4)
								</b>
							</button>
							<!--置亮編輯-->
							<button id="btn_br" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning disabled">
								<b>Bright<br>cancel(S5)
								</b>
							</button>
							<button id="btn_markCancel" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-danger ">
								<b>Mark<br>cancel()
								</b>
							</button>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-4 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Action</div>
						<div class="row m-0">
							<button id="btn_confirm" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Confirm<br>(S1~S5)
								</b>
							</button>
							<button id="btn_exp_excel" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-info">
								<b>Export<br>Excel</b>
							</button>
							<button id="btn_inp_excel_ex" type="button"
								class="lh-1 col p-1 m-1 btn btn-sm btn-outline-warning">
								<b>Inport<br>Excel Ex</b>
							</button>
							<button id="btn_inp_excel" type="button"
								class="lh-1 col-6 p-1 m-1 btn btn-sm btn-outline-danger">
								<div class="row m-0">
									<div class="col-4 p-0">Inport<br>Excel</div>
									<div class="col-8 p-0"><input
											class="col-12 m-0 p-1 border border-dark form-control-file" type="file"
											value="" placeholder="Ex:" accept=".xlsx"></div>
								</div>
							</button>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3 p-1">
					<div class="border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Search</div>
						<div class="row m-0">
							<div class="lh-1 col p-1 m-1 border border-primary rounded">
								<input id="btn_not_sync" alt="" title="" type="checkbox"
									class="m-0 form-check-input checkbox_16 border border-dark"> <br> <b
									style="font-size: 12px;">Not Sync</b>
							</div>
							<div class="lh-1 col p-1 m-1 border border-primary rounded">
								<input id="btn_send_auto" alt="" title="" type="checkbox"
									class="m-0 form-check-input checkbox_16 border border-dark"> <br> <b
									style="font-size: 12px;">Auto(30s)</b>
							</div>
							<button id="btn_send" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Query<br>(AR)
								</b>
							</button>
							<button id="btn_clearAll" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning">
								<b>Clear<br>all()
								</b>
							</button>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
	<!-- 編輯面板 -->
	<div id="search_c_modify" class="col-12 p-1 ">
		<div class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-warning text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square" data-bs-toggle="collapse"
				data-bs-target="#search_c_modify_open" aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_c_modify_open" class="row m-0 collapse">
			<b class="p-0 m-0 lh-1 wlr bg-warning text-white"> Modify </b>
			<table id="inputExcelEx" class="d-none">
				<thead class="">
					<tr class="">
						<th>sonb</th>
						<th>sofodate</th>
						<th>sofokdate</th>
						<th>soscstatus</th>
						<th>soscnote</th>
						<!--物控-->
						<th>somcdate</th>
						<th>somcnote</th>
						<!--倉庫製造-->
						<th>sowmnote</th>
						<th>sompnote</th>
					</tr>
				</thead>
				<tbody class="">
					<tr class="">
						<th>工單號</th>
						<th>生管-加工廠-開工日</th>
						<th>生管-加工廠-完工日</th>
						<th>生管-狀態</th>
						<th>生管-備註</th>
						<!--物控-->
						<th>物控-預計齊料日</th>
						<th>物控-備註</th>
						<!--倉庫製造-->
						<th>倉庫-備註</th>
						<th>製造-備註</th>
					</tr>
				</tbody>
			</table>
			<table
				class="col m-0 p-0 border border-primary table table-striped table-hover table-sm table-bordered table-responsive table-style shadow-sm">
				<thead class="table-warning fixedCt">
					<tr class="">
						<th class="fixedC1">Btn</th>
						<th class="mfy_sonb_show mfy_sonb fixedC1" style="min-width: 100px;">工單號</th>
						<th class="mfy_sofo_show mfy_sofodate" style="min-width: 100px;">加工廠-開工日</th>
						<th class="mfy_sofo_show mfy_sofokdate" style="min-width: 100px;">加工廠-完工日</th>
						<th class="mfy_sosc_show mfy_soscstatus" style="min-width: 100px;">生管狀態</th>
						<th class="mfy_sosc_show mfy_soscnote" style="min-width: 100px;">生管備註</th>
						<!--物控-->
						<th class="mfy_somc_show mfy_somcdate" style="min-width: 100px;">預計齊料日</th>
						<th class="mfy_somc_show mfy_somcnote" style="min-width: 100px;">物控備註</th>
						<!--倉庫製造-->
						<th class="mfy_sowm_show mfy_sowmnote" style="min-width: 100px;">倉庫備註</th>
						<th class="mfy_somp_show mfy_sompnote" style="min-width: 100px;">製造備註</th>
						<th class="mfy_sobr_show mfy_bright" style="min-width: 100px;">置亮取消</th>
					</tr>
				</thead>
				<tbody class="table-white">
					<tr id="mfyEx" class="d-none">
						<th class="mfy_sonb_choose fixedC1"></th>
						<th class="mfy_sonb_show fixedC1">
							<div class="p-1">
								<input class="mfy_sonb_val col-12 m-0 p-1 border border-dark form-control"
									disabled="disabled" type="text" placeholder="Ex:單別-單號?">
							</div>
						</th>
						<th class="mfy_sofo_show">
							<div class="p-1">
								<textarea class="mfy_sofodate_val col-12 m-0 p-1 border border-dark form-control"
									rows="3"></textarea>
							</div>
						</th>
						<th class="mfy_sofo_show">
							<div class="p-1">
								<textarea class="mfy_sofokdate_val col-12 m-0 p-1 border border-dark form-control"
									rows="3"></textarea>
							</div>
						</th>
						<th class="mfy_sosc_show">
							<div class="p-1">
								<select class="mfy_soscstatus_val col-12 m-0 p-1 border border-dark form-select">
									<option value="" selected="selected">select(請選擇)</option>
									<option value="1">已發料</option>
									<option value="2">部分缺料</option>
									<option value="3">備料中</option>
									<option value="4">未生產</option>
									<option value="5">待打件通知</option>
								</select>
							</div>
						</th>
						<th class="mfy_sosc_show">
							<div class="p-1">
								<textarea class="mfy_soscnote_val col-12 m-0 p-1 border border-dark form-control"
									rows="1"></textarea>
							</div>
						</th>
						<!--物控-->
						<th class="mfy_somc_show">
							<div class="p-1">
								<input
									class="mfy_somcdate_val col-12 m-0 p-1 border border-dark form-control datetimepicker_onlydate"
									type="text" placeholder="Ex:2024-01-01?">
							</div>
						</th>
						<th class="mfy_somc_show">
							<div class="p-1">
								<textarea class="mfy_somcnote_val col-12 m-0 p-1 border border-dark form-control"
									rows="1"></textarea>
							</div>
						</th>
						<!--倉儲-->
						<th class="mfy_sowm_show">
							<div class="p-1">
								<textarea class="mfy_sowmnote_val col-12 m-0 p-1 border border-dark form-control"
									rows="1"></textarea>
							</div>
						</th>
						<!--產線-->
						<th class="mfy_somp_show">
							<div class="p-1">
								<textarea class="mfy_sompnote_val col-12 m-0 p-1 border border-dark form-control"
									rows="1"></textarea>
							</div>
						</th>
						<!--置亮-->
						<th class="mfy_sobr_show">
							<div class="p-1">
								<input class="mfy_sobr_val col-12 m-0 p-1 border border-dark checkbox_24"
									type="checkbox" checked>
							</div>
						</th>
					</tr>
				</tbody>
			</table>

		</div>
	</div>

	<!-- 查詢結果 -->
	<div id="search_cr" class="col-12 m-0 p-1">
		<div class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-info text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square" data-bs-toggle="collapse"
				data-bs-target="#search_cr_open" aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="search_cr_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-info text-white"> Result </b>
			<table id="searchReportExcel"
				class="col m-0 p-0 border border-primary table table-striped table-hover table-sm table-bordered table-responsive table-style shadow-sm">
				<thead class="table-primary fixedCt">
					<tr>
						<th class="fixedC1 markFn" style="min-width: 40px;">
							<div>
								<button id="exthAll" type="button" class="lh-1 col p-1 m-0 btn btn-sm btn-outline-dark">
									<b>M</b>
								</button>
							</div>
						</th>
						<th class="exTheadth d-none" style="min-width: 100px;">N/A</th>
					</tr>
				</thead>
				<tbody class="table-white">
					<tr class="exTbodyTr d-none">
						<th class="fixedC1 exTbodyTh markFn" style="max-width: 40px;">
							<div class="">
								<input disabled="disabled" alt="row_x" title="IKey_GKey" type="checkbox"
									class="m-0 form-check-input checkbox_24 border border-dark">
							</div>
						</th>
						<td class="exTbodytd d-none" style="max-width: 100px"></td>
					</tr>
					<tr class="exTbodyTrYW d-none">
						<th colspan="5" class="fixedC1 TbodyThYW" style="background-color: rgb(255, 255, 0);">
						<th colspan="30" class="TbodyThYWO" style="background-color: rgb(255, 255, 0);">
						<th colspan="5" class="TbodyThYWO d-none" style="background-color: rgb(255, 255, 0);">
						</th>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
	//宣告
	//console.log("other.html(init)");
	other = {
		//資料
		data: {
			marks: {},//有選取的IKeyGKey
			entityFormatJson: {},//查詢格式
			btn_send_auto: "",//自動傳送
			//換頁設置
			searchPageSet: {
				total: 500,//批次數量(1-1000)
				batch: 0,//第幾批次(1-1000)
				pageNew: 1,//單前頁碼(1-50)
				pageSize: 500,//每頁數量(1-20)
				entityJsons: [],//資料
				entityDetailJsons: [],//細節資料
				entityIKey: "",//ID
				entityGKey: "",//GID
				entityDateTime: "",//是時間格式的欄位 
			},
			searchSet: {},
			websocket: "",//Websocket 連接物件
			entityJsonForWebsocket: "",//需要更新內容物
			modifyDoing: false,
			valTbodyTr: 0,//筆數量
		},
		//方法
		methods: {
			create() {
				//==========================第一次載入==========================
				//Step0.初始化
				console.log("other.html(created)");
				//查詢格式
				other.data.entityFormatJson = JSON.parse(main.resq_data['entityFormatJson']);
				//查詢項目 
				var searchSetJson = JSON.parse(main.resq_data['searchSet']);
				//資料內容
				other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
				other.data.searchPageSet.entityDetailJsons = JSON.parse(main.resq_data['entityDetailJson']);
				other.data.entityIKey = main.resq_data['entityIKeyGKey'].split("_")[0];
				other.data.entityGKey = main.resq_data['entityIKeyGKey'].split("_")[1];
				other.data.entityDateTime = main.resq_data['entityDateTime'];
				other.data.searchSet = searchSetJson['searchSet'];
				console.log(other.data.searchPageSet.entityJsons);
				//按鈕權限?
				var p = $("#nav_functional_unit").attr("alt").split("<_>")[2];
				var ps = Array.from(p);
				var btn_confirm = false;
				if (ps[10] != 1) {//查詢(AR)10
					$("#btn_send").addClass("disabled");
				} if (ps[5] == 1) {//修改-生館編輯(S1)5
					$("#btn_pc").removeClass("disabled");
					btn_confirm = true;
				} if (ps[4] == 1) {//修改-物控編輯(S2)4
					$("#btn_mc").removeClass("disabled");
					btn_confirm = true;
				} if (ps[3] == 1) {//修改-倉庫編輯(S3)3
					$("#btn_wm").removeClass("disabled");
					btn_confirm = true;
				} if (ps[2] == 1) {//修改-產線編輯(S4)2
					$("#btn_pl").removeClass("disabled");
					btn_confirm = true;
				} if (ps[1] == 1) {//修改-置亮(S5)1
					$("#btn_br").removeClass("disabled");
					btn_confirm = true;
				}
				//如果S1-S4 沒有權限 
				if (!btn_confirm) {//確認?
					$("#btn_confirm").addClass("disabled");
				}

				//Step1.查詢結果標題-排序
				var resultThead = searchSetJson['resultThead'];
				var entityJsons = other.data.searchPageSet.entityJsons;
				var pageSize = other.data.searchPageSet.pageSize;//每頁數量(1-20)
				resultThead = main.methods.orderedSort(resultThead);
				//
				var resultDetailThead = searchSetJson['resultDetailThead'];
				resultDetailThead = main.methods.orderedSort(resultDetailThead);
				//console.log(resultThead);
				//Step2.查詢結果標題-資料
				var check1 = true, check2 = true, check3 = true, check4 = true;
				var left = 40;
				Object.keys(resultThead).forEach(function (k) {
					//console.log(k + ' - ' + resultThead[k]);
					//複製格式
					var exTheadth = $('#search_cr_open .exTheadth').clone();
					var exTbodytd = $('#search_cr_open .exTbodytd').clone();
					exTheadth.removeClass('exTheadth');
					exTheadth.removeClass('d-none')
					exTheadth.addClass('titTheadth');
					//
					exTbodytd.removeClass('exTbodytd');
					exTbodytd.removeClass('d-none')
					exTbodytd.addClass('valTbodytd');
					exTbodytd.addClass(resultThead[k].cellName);
					//固定第一/二/三/四格式
					if (check1 && resultThead[k].show == 1) {
						check1 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', "40px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', "40px");
						left += resultThead[k].width;
					} else if (check2 && resultThead[k].show == 1) {
						check2 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', left + "px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', left + "px");
						left += resultThead[k].width;
					} else if (check3 && resultThead[k].show == 1) {
						check3 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', left + "px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', left + "px");
						left += resultThead[k].width;
					} else if (check4 && resultThead[k].show == 1) {
						check4 = false;
						exTheadth.addClass('fixedC1');
						exTheadth.css('left', left + "px");
						exTbodytd.addClass('fixedC1');
						exTbodytd.css('left', left + "px");
						left += resultThead[k].width;
					}
					//生館區塊
					if (resultThead[k].cellName == "sofodate" ||
						resultThead[k].cellName == "sofokdate" ||
						resultThead[k].cellName == "soscstatus" ||
						resultThead[k].cellName == "soscnote") {
						exTheadth.addClass('border-secondary');
						exTbodytd.addClass('border-secondary');
					}
					//物控區塊
					if (resultThead[k].cellName == "somcdate" ||
						resultThead[k].cellName == "somcnote" ||
						resultThead[k].cellName == "somcstatus") {
						exTheadth.addClass('border-success');
						exTbodytd.addClass('border-success');
					}
					//倉儲區塊
					if (resultThead[k].cellName == "sowmprogress" ||
						resultThead[k].cellName == "sowmnote") {
						exTheadth.addClass('border-info');
						exTbodytd.addClass('border-info');
					}
					//如果有翻譯
					if (resultThead[k].cellLanguage != '') {
						var cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
						exTheadth.text(cellName == "" ? resultThead[k].cellName : cellName);//有可能內容是空的
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
						//編輯
						if ($(".mfy_" + resultThead[k].cellName).length > 0) {
							$(".mfy_" + resultThead[k].cellName).text(cellName == "" ? resultThead[k].cellName : cellName);//有可能內容是空的
							$(".mfy_" + resultThead[k].cellName).css('minWidth', resultThead[k].width + "px");
						}
					} else {
						exTheadth.text(resultThead[k].cellName);
						exTheadth.css('minWidth', resultThead[k].width + "px");
						exTbodytd.css('maxWidth', resultThead[k].width + "px");
					}
					//如果隱藏
					if (resultThead[k].show == 0) {
						exTheadth.addClass('d-none');
						exTbodytd.addClass('d-none');
					}
					//添加
					$('#search_cr_open .exTheadth').before(exTheadth);
					$('#search_cr_open .exTbodytd').before(exTbodytd);
				});

				//Step2.查詢結果標題(細節)-資料
				if (JSON.stringify(resultDetailThead) == '{}') {
					$('#btn_detail').addClass('disabled');
					$('#search_dcr').addClass('d-none');
				}
				//Step3.查詢內容-格式(資料筆數)
				for (var b = 1; b <= 10; b++) {
					var exTbodyTr = $('.exTbodyTr').clone();
					exTbodyTr.removeClass('exTbodyTr');
					exTbodyTr.addClass('valTbodyTr_' + b);
					exTbodyTr.find('input').attr("alt", "row_" + b);
					$('.exTbodyTr').before(exTbodyTr);
				}
				$('.exTbodyTr').addClass('d-none');
				other.data.valTbodyTr = 10;

				//Step4.查詢條件
				for (var t = 0; t < searchSetJson['searchSet'].length; t++) {
					var searchSet = searchSetJson['searchSet'][t];
					var searchTextEx = "";
					var searchSelectEx = "";
					var selectEx = "";
					//不顯示
					if (!searchSet['show']) {
						continue;
					}
					if (searchSet['type'] != 'select') {
						//一般文字
						searchTextEx = $('.searchTextEx').clone();
						searchTextEx.removeClass("searchTextEx");
						searchTextEx.removeClass("col-md-1");
						searchTextEx.removeClass("d-none");
						searchTextEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchTextEx.find('input').attr("id", searchSet['searchName']);
						searchTextEx.find('input').attr("name", searchSet['searchName']);
						searchTextEx.find('input').attr("placeholder", searchSet['placeholder']);
						searchTextEx.find('input').addClass("searchVal");
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									var cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchTextEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchTextEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
					} else {
						//選擇選單
						searchSelectEx = $('.searchSelectEx').clone();
						searchSelectEx.removeClass("searchSelectEx");
						searchSelectEx.removeClass("col-md-1");
						searchSelectEx.removeClass("d-none");
						searchSelectEx.addClass(searchSet['width'].replaceAll("_", "-"));
						searchSelectEx.find('select').attr("id", searchSet['searchName']);
						searchSelectEx.find('select').attr("name", searchSet['searchName']);
						searchSelectEx.find('select').addClass("searchVal");
						//查詢欄位
						Object.keys(resultThead).forEach(function (k) {
							//如果有翻譯
							if (k.indexOf(searchSet['searchName']) >= 0) {
								if (resultThead[k].cellLanguage != '') {
									var cellName = JSON.parse(resultThead[k].cellLanguage)[$('#menu_login_language').text()];
									searchSelectEx.find('.searchTitle').text(cellName == "" ? searchSet['searchName'] : cellName);
								} else {
									searchSelectEx.find('.searchTitle').text(searchSet['searchName']);
								}
							}
						});
						//選項
						for (var s = 0; s < searchSet['select'].length; s++) {
							var key = searchSet['select'][s].split("_")[0];
							var val = searchSet['select'][s].split("_")[1];
							selectEx = searchSelectEx.find('.selectEx').clone();
							selectEx.removeClass("selectEx");
							selectEx.removeAttr("selected");
							selectEx.text(key);
							selectEx.val(val);
							selectEx.appendTo(searchSelectEx.find('select'));
						}
					}
					switch (searchSet['type']) {
						case "select":
							searchSelectEx.appendTo('#searchItem');
							break;
						case "text":
							searchTextEx.appendTo('#searchItem');
							break;
						case "time":
							searchTextEx.find('input').addClass('datetimepicker_time');
							searchTextEx.appendTo('#searchItem');
							break;
						case "datetime":
							searchTextEx.find('input').addClass('datetimepicker_date');
							searchTextEx.appendTo('#searchItem');
							break;
					}
				}
				//時間格式
				other.methods.datetimepickerDate();
				//Step5.帶入資料
				//other.methods.otherReLoad();

				//==========================監聽==========================
				//監聽-全選資料
				$(document).off("click", "#search_c #exthAll");
				$(document).on("click", "#search_c #exthAll", function (event) {
					//都有勾選?
					var clickAll = true;
					$("#search_cr_open .exTbodyTh").each(function () {
						if ($(this).find("input").attr("disabled") != "disabled" && $(this).find("input").prop("checked") == false) {
							$(this).find("input").trigger("click");
							clickAll = false;
						}
					});
					//全部取消?
					if (clickAll) {
						$("#search_cr_open .exTbodyTh").find("input").trigger("click");
					}
				});
				//監聽-標記移除
				$(document).off("click", "#search_c #btn_markCancel");
				$(document).on("click", "#search_c #btn_markCancel", function (event) {
					console.log("btn_markCancel");
					//如果有需要解鎖
					if ($('#search_c_modify tbody .mfy_datas').length > 0) {
						other.methods.websocketPage();
						other.methods.websocketSendMessage("sendAllUnlock");//執行查看解鎖						
					}

					other.methods.searchToModifyRe();
					//編輯->不顯示
					if ($("#search_c_modify_open").hasClass("show")) {
						$("#search_c_modify .bi-dash-square").trigger('click');
					}

					other.data.marks = {};
					$('.exTbodyTh input').prop("checked", false);
					other.data.modifyDoing = false;
				});
				//監聽-選取資料
				$(document).off("change", "#search_c #search_cr_open .exTbodyTh input");
				$(document).on("change", "#search_c #search_cr_open .exTbodyTh input", function (event) {
					console.log("search_cr_open");
					//一般資料
					var Ikey_Gkey = event.target.title;
					var check = event.target.checked;
					//標記-選取|解除
					if (check == true) {
						other.data.marks[Ikey_Gkey] = true;
						//console.log(entityDetailJsons);	
					} else {
						for (var k in other.data.marks) {
							if (k == Ikey_Gkey) {
								delete other.data.marks[k];
								break;
							};
						}
					}
					//console.log(other.data.marks);	
				});
				//監聽-生管編輯(S1)
				$(document).off("click", "#search_c #btn_pc");
				$(document).on("click", "#search_c #btn_pc", function (event) {
					console.log("btn_pc");
					other.methods.searchToModify("btn_pc");
				});
				//監聽-物控編輯(S2)
				$(document).off("click", "#search_c #btn_mc");
				$(document).on("click", "#search_c #btn_mc", function (event) {
					console.log("btn_mc");
					other.methods.searchToModify("btn_mc");
				});
				//監聽-生管編輯(S3)
				$(document).off("click", "#search_c #btn_wm");
				$(document).on("click", "#search_c #btn_wm", function (event) {
					console.log("btn_wm");
					other.methods.searchToModify("btn_wm");
				});
				//監聽-生管編輯(S4)
				$(document).off("click", "#search_c #btn_pl");
				$(document).on("click", "#search_c #btn_pl", function (event) {
					console.log("btn_pl");
					other.methods.searchToModify("btn_pl");
				});
				//監聽-置亮編輯(S5)
				$(document).off("click", "#search_c #btn_br");
				$(document).on("click", "#search_c #btn_br", function (event) {
					console.log("btn_br");
					other.methods.searchToModify("btn_br");
				});
				//監聽-清除查詢
				$(document).off("click", "#search_c #btn_clearAll");
				$(document).on("click", "#search_c #btn_clearAll", function (event) {
					console.log("btn_clearAll");
					$("#searchItem input").val("");
					$("#searchItem select").val("");

				});
				//監聽-查詢
				$(document).off("click", "#search_c #btn_send");
				$(document).on("click", "#search_c #btn_send", function (event) {
					console.log("btn_send");
					other.methods.searchSend(0);
					if ($("#btn_send_auto").prop("checked")) {
						other.data.btn_send_auto = setTimeout(function () {
							$("#search_c #btn_send").trigger("click");
						}, 30000);
					} else {
						clearTimeout(other.data.btn_send_auto);
					}
				});
				//監聽-查詢(促發)
				$(document).off("keyup", "#searchItem input");
				$(document).on("keyup", "#searchItem input", function (e) {
					if (e.key === 'Enter' || e.keyCode === 13) {
						$(e.currentTarget).select();
						$("#search_c #btn_send").trigger("click");
					}
				});

				//監聽-備註開啟(促發)
				$(document).off("mouseenter mouseleave", ".noteShow");
				$(document).on("mouseenter mouseleave", ".noteShow", function (e) {
					//console.log($(this)[0].style.height);
					if ($(this)[0].style.height != "auto") {
						$(this).css("height", "auto");
					} else {
						$(this).css("height", "80px");
					}
				});

				//監聽-修改傳送
				$(document).off("click", "#search_c #btn_confirm");
				$(document).on("click", "#search_c #btn_confirm", function (event) {
					console.log("btn_confirm");
					other.data.modifyDoing = false;
					other.methods.confirmSend();
				});
				//監聽-Excel匯出
				$(document).off("click", "#search_c #btn_exp_excel");
				$(document).on("click", "#search_c #btn_exp_excel", function (event) {
					console.log("btn_exp_excel");
					other.methods.exportExcel();
				});

				//上傳檔案Ex?
				$(document).off("click", "#btn_inp_excel_ex");
				$(document).on("click", "#btn_inp_excel_ex", function (event) {
					var inputExcelEx = $('#inputExcelEx').clone();
					var options = {
						workbook: {
							views: [{
								x: 0, y: 0, width: 10000, height: 20000,
								firstSheet: 0, activeTab: 1, visibility: 'visible'
							}]
						},
						widthRatio: 0.55,//寬度比例
						plugins: [
							{
								workbookCreated({workbook, tables}) {

								}, worksheetCreated({workbook, tables, worksheet, table}) {

								}, workcellCreated({workbook, tables, worksheet, table, workcell, cell, cellStyle, colRange, rowRange}) {

								}, worksheetCompleted({workbook, tables, worksheet, table}) {

								}
							},
						]
					}
					const table2Excel = new Table2Excel(inputExcelEx, options);//id or class or table
					table2Excel.export($('#nav_functional_unit').text() + "_Ex", 'xlsx');//檔案名稱+副檔名
				});
				//上傳檔案?
				$(document).off("change", "#btn_inp_excel .form-control-file");
				$(document).on("change", "#btn_inp_excel .form-control-file", function (event) {
					console.log("form-control-file");
					var target = $(event.target);
					//沒檔案?
					if (!this.files || !this.files[0] || target.attr("accept") != ".xlsx") {
						target.val("");
						return;
					}
					//取得狀態(生管/物控/倉儲.....)
					var choose = $("#search_c_modify_open .mfy_datas1").find(".mfy_sonb_choose").text();
					//分析完成->比對資料寫入
					var jsonResult = other.methods.inputExcel(this.files[0]);
					jsonResult.then((res) => {
						console.log(res['inputExcel']);
						//每個Excel欄位
						res['inputExcel'].forEach(function (t) {
							console.log(t);
							var inExcel = $("#search_c_modify_open ." + t.sonb);
							//有比對到
							if (inExcel != null) {
								switch (choose) {
									case "pc"://生館
										inExcel.find(".mfy_sofodate_val").val(t.sofodate);
										inExcel.find(".mfy_sofokdate_val").val(t.sofokdate);
										inExcel.find(".mfy_soscstatus_val").val(t.soscstatus);
										inExcel.find(".mfy_soscnote_val").val(t.soscnote);
										break
									case "mc"://物控
										inExcel.find(".mfy_somcdate_val").val(t.somcdate);
										inExcel.find(".mfy_somcnote_val").val(t.somcnote);
										break;
									case "wm"://倉儲
										inExcel.find(".mfy_sowmnote_val").val(t.sowmnote);

										break;
									case "pl"://製造
										inExcel.find(".mfy_sompnote_val").val(t.sompnote);
										break;
								}
							}
						});
					});
				});
				//WebsocketAction 建立
				other.methods.websocketInit();
			},
			//==========================Excel ==========================
			inputExcel(file) {
				var reader = new FileReader();
				reader.readAsBinaryString(file);
				//https://www.casper.tw/development/2020/02/16/all-new-promise/
				//
				return new Promise((resolve, reject) => {
					reader.onload = function (e) {
						var data = e.target.result;
						var workbook = XLSX.read(data, {
							type: "binary",
						});
						var result = {};
						workbook.SheetNames.forEach(function (sheetName) {
							var roa = XLSX.utils.sheet_to_row_object_array(
								workbook.Sheets[sheetName]
							);
							if (roa.length > 0) {
								result['inputExcel'] = roa;
							}
						});
						resolve(result);
					};
				});
			},
			exportExcel() {
				//https://github.com/JackGit/table2excel.js
				//設置
				var options = {
					workbook: {
						views: [{
							x: 0, y: 0, width: 10000, height: 20000,
							firstSheet: 0, activeTab: 1, visibility: 'visible'
						}]
					},
					widthRatio: 0.55,//寬度比例
					plugins: [
						{
							workbookCreated({workbook, tables}) {
								console.log(tables);
								//創建時(Excel)
							}, worksheetCreated({workbook, tables, worksheet, table}) {
								console.log(table);
								//創建時(分頁簿)
								//console.log(tables);
							}, workcellCreated({workbook, tables, worksheet, table, workcell, cell, cellStyle, colRange, rowRange}) {
								//https://github.com/exceljs/exceljs/blob/master/README_zh.md#%E5%9B%BE%E7%89%87
								//創建時(每一格欄位)-呼叫
								var cellWidth = $(cell).css("minWidth").replaceAll('px', '');
								//console.log(cell);
								//指定欄位顏色
								if ($(cell).hasClass("TbodyThYW") || $(cell).hasClass("TbodyThYWO")) {
									workcell.fill = {
										type: 'pattern',
										pattern: 'darkTrellis',
										fgColor: {argb: 'FFFFFF00'},
										bgColor: {argb: 'FFFF00'}
									};
								}
								//指定內容不顯示
								if ($(cell).hasClass("d-none")) {
									workcell.text = "";
									workcell.value = "";
								}
								//有效果
								/**/
							}, worksheetCompleted({workbook, tables, worksheet, table}) {
								//完成時-呼叫
								//worksheet.getRow(1).hidden = true//隱藏第一筆
								//worksheet.getColumn(1).hidden = true;//隱藏第一行
							}
						},
					]
				}
				//資料準備
				var todayDate = new Date().toISOString().slice(0, 10);
				var searchReportExcel = $('#searchReportExcel').clone();
				searchReportExcel.find('.markFn').remove();
				searchReportExcel.find('button').remove();
				searchReportExcel.find('.valTbodyTrYW').remove();
				searchReportExcel.find('.d-none').remove();
				//searchReportExcel.find('.markFn').remove();
				//置換資料-生管(換行)
				searchReportExcel.find('.soscnote').each(function () {
					var k = "\n"
					$(this).find('.needbr').each(function () {
						this.innerHTML = this.innerHTML.replace(/[^\x00-\xff]/g, "$&\x01").replace(/.{50}\x01?/g, "$&\n").replace(/\x01/g, "");
						k += this.innerHTML.replaceAll("<br>", "\n") + "\n";
					});
					//console.log(k);
					$(this).html(k);
				});
				//置換資料-物控(換行)
				searchReportExcel.find('.somcnote').each(function () {
					var k = "\n"
					$(this).find('.needbr').each(function () {
						this.innerHTML = this.innerHTML.replace(/[^\x00-\xff]/g, "$&\x01").replace(/.{50}\x01?/g, "$&\n").replace(/\x01/g, "");
						k += this.innerHTML.replaceAll("<br>", "\n") + "\n";
					});
					//console.log(k);
					$(this).html(k);
				});
				//置換資料-倉儲(換行)
				searchReportExcel.find('.sowmnote').each(function () {
					var k = "\n"
					$(this).find('.needbr').each(function () {
						this.innerHTML = this.innerHTML.replace(/[^\x00-\xff]/g, "$&\x01").replace(/.{50}\x01?/g, "$&\n").replace(/\x01/g, "");
						k += this.innerHTML.replaceAll("<br>", "\n") + "\n";
					});
					//console.log(k);
					$(this).html(k);
				});
				//置換資料-製造(換行)
				searchReportExcel.find('.sompnote').each(function () {
					var k = "\n"
					$(this).find('.needbr').each(function () {
						this.innerHTML = this.innerHTML.replace(/[^\x00-\xff]/g, "$&\x01").replace(/.{50}\x01?/g, "$&\n").replace(/\x01/g, "");
						k += this.innerHTML.replaceAll("<br>", "\n") + "\n";
					});
					//console.log(k);
					$(this).html(k);
				});

				//置換資料 Note(換行)
				searchReportExcel.find('.sonote').each(function () {
					var k = this.innerHTML.replace(/[^\x00-\xff]/g, "$&\x01").replace(/.{50}\x01?/g, "$&\n").replace(/\x01/g, "");
					$(this).html(k);
				});


				//searchReportExcel.find('div').remove();
				const table2Excel = new Table2Excel(searchReportExcel, options);//id or class or table
				table2Excel.export($('#nav_functional_unit').text() + "_" + todayDate, 'xlsx');//檔案名稱+副檔名
			},

			//==========================Websocket傳送動作==========================
			//WebsocketAction
			websocketInit() {
				var ws = "ws://";
				ws += location.host;
				ws += "/DTRcloud/websocket/schedule_outsourcer_client/echo?userAcc=";
				ws += $("#menu_login_name").attr("alt");

				//console.log(ip);
				other.data.websocket = new WebSocket(ws);
				other.data.websocket.onclose = e => {
					// 連線斷開
					console.log('連線關閉: code=' + e.code + ', reason=' + e.reason + '');
				}
				other.data.websocket.onmessage = e => {
					//Step1. 收到訊息
					var dataJson = JSON.parse(e.data);
					//Step2.取出資料
					var update = dataJson.update;
					var status = dataJson.status;
					var action = dataJson.action;
					//一般查詢 or 同步+沒勾選同步鎖(指同步有的資料)
					if ($("#btn_not_sync").prop("checked")) {
						var updateCheck = JSON.parse(update);
						var updateNewData = [];
						other.data.searchPageSet.entityJsons.forEach(function (t) {
							updateCheck.forEach(function (n) {
								if (t.soid == n.soid) {
									updateNewData.push(n);
								}
							});
						});
						other.data.searchPageSet.entityJsons = [];
						other.data.searchPageSet.entityJsons = updateNewData;
					} else {
						//沒鎖定
						other.data.searchPageSet.entityJsons = [];
						other.data.searchPageSet.entityJsons = JSON.parse(update);
					}
					console.log(other.data.searchPageSet.entityJsons);
					console.log('收到訊息：' + status);
					//Step3.確認有效
					if (status) {
						switch (action) {
							case "sendAllLock":
								break;
							case "sendAllUnlock":
								break;
							default:
								//因S1~S5確認後 清除資料
								if (!other.data.modifyDoing) {
									$("#btn_markCancel").trigger('click');
								}
								break;
						}
						//Step4.刷新資料


						other.methods.otherReLoad(action);
					} else {
						//失敗時候也清除
						$("#btn_markCancel").trigger('click');
					}
					//還原
					//other.data.entityJsonForWebsocket = [];
				}
				other.data.websocket.onerror = e => {
					// 例外
					console.log("連線異常")
				}
				other.data.websocket.onopen = e => {
					// 連線開啟時
					console.log("連線開啟");
					other.methods.websocketSendMessage("sendOnlyData");
				}
			},
			websocketSendMessage(action) {
				//{"user":"system","action":"leave/sendAllData/sendAllLock/sendAllUnlock","update":""}
				//包裝語法
				var objson = {};
				var objstring = {};
				objson.user = $("#menu_login_name").attr("alt");
				objson.update = other.data.entityJsonForWebsocket;

				//leave/sendAllData/sendOnlyData/sendAllLock/sendAllUnlock
				switch (action) {
					case "leave":
						objson.action = "leave";
						// 也可以由客戶端主動斷開
						// other.data.websocket.close();
						break;
					case "sendAllData":
						objson.action = "sendAllData";
						break;
					case "sendOnlyData":
						objson.action = "sendOnlyData";
						break;
					case "sendAllLock":
						objson.action = "sendAllLock";
						break;
					case "sendAllUnlock":
						objson.action = "sendAllUnlock";
						break;
					case "sendAllClearShow":
						objson.action = "sendAllClearShow";
						break;
				}
				objstring = JSON.stringify(objson);
				// 建立連線後，往伺服器傳送資訊
				other.data.websocket.send(objstring);
			},
			//==========================時間格式載入==========================
			datetimepickerDate() {
				//日期時間格式
				$('#search_c .datetimepicker_onlydate').datetimepicker({
					format: 'yyyy-mm-dd',
					pickerPosition: 'bottom-right',
					startView: 2,// 點擊時會出現的view。0為分、1為時、2為日、3為月、4為年。
					minView: 2,//選取時最小的顯示view。0為分、1為時、2為日、3為月、4為年
					//startView差異在於如果startView:3,minView:0 ，選完月份之後得要一路選到分才能停。
					// hoursDisabled: [00, 1, 2, 3, 4, 5, 6],
					//minuteStep: 30,
					autoclose: true,
					//endDate: '+1d',
					//datesDisabled: '+1d',
					timepicker: false,
					todayBtn: true,
					bootcssVer: 5,
					//......可以同上項目代碼自定義設置
				});
				//日期時間格式
				$('#search_c .datetimepicker_date').datetimepicker({
					format: 'yyyy-mm-dd hh:ii:00',
					pickerPosition: 'bottom-right',
					//minView:1,
					// hoursDisabled: [00, 1, 2, 3, 4, 5, 6],
					minuteStep: 30,
					autoclose: true,
					//endDate: '+1d',
					//datesDisabled: '+1d',
					todayBtn: true,
					bootcssVer: 5,
					//......可以同上項目代碼自定義設置
				});
				//時間格式
				$('#search_c .datetimepicker_time').datetimepicker({
					format: 'hh:ii',
					startView: 1,
					minuteStep: 30,
					pickDate: false,
					autoclose: true,
					timeFormat: 'hh:mm',
				});
			},
			//==========================修改資料==========================
			searchToModify(order) {
				//是否marks?markDetails?

				var marks = other.data.marks;
				if (JSON.stringify(marks) == "{}") {
					return null;
				}
				//是否有人選了?
				var someoneUsed = false;
				$('#search_cr_open tbody tr').each(function () {
					if ($(this).find('input').prop("checked")) {
						if ($(this).hasClass('table-danger')) {
							if (JSON.parse($(this).find('.tag').text()).lockeduser != $("#menu_login_name").attr("alt")) {
								someoneUsed = true;
							}
						}
					}
				});
				if (someoneUsed) {
					return null;
				}

				//->還原
				other.methods.searchToModifyRe();
				//Step6.編輯筆數-複製
				var count = Object.keys(marks).length;
				for (var d = 1; d <= count; d++) {
					var mfyEx = $("#mfyEx").clone();
					mfyEx.attr("id", "");
					mfyEx.addClass("mfy_datas");
					mfyEx.addClass("mfy_datas" + d);
					$("#mfyEx").before(mfyEx);
				}
				console.log(JSON.stringify(marks));
				//編輯->顯示
				if (!$("#search_c_modify_open").hasClass("show")) {
					$("#search_c_modify .bi-dash-square").trigger('click');
				}
				//顯示標題?
				$("thead .mfy_sonb_show").removeClass("d-none");
				switch (order) {
					case "btn_pc"://生管
						$("thead .mfy_sofo_show").removeClass("d-none");
						$("thead .mfy_sosc_show").removeClass("d-none");
						$(".mfy_sonb_choose").text("pc");
						break
					case "btn_mc"://物控
						$("thead .mfy_somc_show").removeClass("d-none");
						$(".mfy_sonb_choose").text("mc");
						break;
					case "btn_wm"://倉儲
						$("thead .mfy_sowm_show").removeClass("d-none");
						$(".mfy_sonb_choose").text("wm");
						break;
					case "btn_pl"://製造
						$("thead .mfy_somp_show").removeClass("d-none");
						$(".mfy_sonb_choose").text("pl");
						break;
					case "btn_br"://置亮
						$("thead .mfy_sobr_show").removeClass("d-none");
						$(".mfy_sonb_choose").text("br");
						break;
				}
				//顯示Data
				var k = 0;//
				$('#search_cr_open tbody tr').each(function () {
					if ($(this).find('input').prop("checked")) {
						//console.log(this);
						k += 1;
						//選擇
						var mfyEx = $(".mfy_datas" + k);
						mfyEx.addClass("mfy_datas");
						mfyEx.removeClass("d-none");
						//資料
						var soid = $(this).find(".soid").text();
						var sonb = $(this).find(".sonb").text();
						var sofodate = $(this).find(".sofodate").text();
						var sofokdate = $(this).find(".sofokdate").text();
						var soscstatus = $(this).find(".soscstatus").attr('title');
						var somcdate = $(this).find(".somcdate").text();
						var soscnote = "";
						var somcnote = "";
						var sowmnote = "";
						var sompnote = "";
						switch (order) {
							case "btn_pc"://生管
								//生館
								if ($(this).find(".soscnote .notes").length > 0) {
									soscnote = $(this).find(".soscnote .notes").first().text();
								}
								mfyEx.find(".mfy_sonb_show").removeClass("d-none");
								mfyEx.find(".mfy_sosc_show").removeClass("d-none");
								mfyEx.find(".mfy_sofo_show").removeClass("d-none")
								break
							case "btn_mc"://物控
								//悟空
								if ($(this).find(".somcnote .notes").length > 0) {
									somcnote = $(this).find(".somcnote .notes").first().text();
								}
								mfyEx.find(".mfy_sonb_show").removeClass("d-none");
								mfyEx.find(".mfy_somc_show").removeClass("d-none");

								break;
							case "btn_wm"://倉儲
								//倉庫
								if ($(this).find(".sowmnote .notes").length > 0) {
									sowmnote = $(this).find(".sowmnote .notes").first().text();
								}
								mfyEx.find(".mfy_sonb_show").removeClass("d-none");
								mfyEx.find(".mfy_sowm_show").removeClass("d-none");
								break;
							case "btn_pl"://製造
								//製造
								if ($(this).find(".sompnote .notes").length > 0) {
									sompnote = $(this).find(".sompnote .notes").first().text();
								}
								mfyEx.find(".mfy_sonb_show").removeClass("d-none");
								mfyEx.find(".mfy_somp_show").removeClass("d-none");
								break;
							case "btn_br"://置亮

								mfyEx.find(".mfy_sonb_show").removeClass("d-none");
								mfyEx.find(".mfy_sobr_show").removeClass("d-none");
								break;
						}
						//資料填入
						mfyEx.attr("id", soid);
						mfyEx.addClass(sonb);
						mfyEx.find(".mfy_sonb_val").val(sonb);
						mfyEx.find(".mfy_sofodate_val").val(sofodate);
						mfyEx.find(".mfy_sofokdate_val").val(sofokdate);
						mfyEx.find(".mfy_soscstatus_val").val(soscstatus);
						mfyEx.find(".mfy_soscnote_val").val(soscnote);
						mfyEx.find(".mfy_soscnote_val").attr("rows", "6");

						mfyEx.find(".mfy_somcdate_val").val(somcdate);
						mfyEx.find(".mfy_somcnote_val").val(somcnote);
						mfyEx.find(".mfy_somcnote_val").attr("rows", "6");

						mfyEx.find(".mfy_sowmnote_val").val(sowmnote);
						mfyEx.find(".mfy_sowmnote_val").attr("rows", "6");
						mfyEx.find(".mfy_sompnote_val").val(sompnote);
						mfyEx.find(".mfy_sompnote_val").attr("rows", "6");
					}
				});
				//是否有人使用?/如果已經鎖住 不需要再傳送
				other.methods.websocketPage();
				other.methods.websocketSendMessage("sendAllLock");//執行查看鎖定
				other.data.modifyDoing = true;//編輯中
			},
			searchToModifyRe() {
				$("#search_c_modify th").addClass("d-none");
				$(".mfy_sonb_choose").text("");
				$("#search_c_modify th input").val("");
				//$("#search_c_modify tbody tr").attr("id", "");
				$("#search_c_modify tbody .mfy_datas").remove();
			},
			//==========================傳送資料==========================
			websocketPage() {//Websocket 抓取選擇用
				//確認選取
				var entityJsons = [];//回傳一般資料
				$('#search_c_modify tbody .mfy_datas').each(function () {
					var entityJso = [];
					if ($(this).attr("id") != "") {
						console.log($(this).attr("id"));
						entityJson = JSON.parse(JSON.stringify(other.data.entityFormatJson));//格式
						entityJson['soid'] = parseInt($(this).attr("id"));
						entityJson['sonb'] = $(this).find(".mfy_sonb_val").val();
						entityJson['sofodate'] = "";
						entityJson['sofokdate'] = "";
						entityJson['soscstatus'] = "4";
						entityJson['soscnote'] = "";
						entityJson['somcdate'] = "";
						entityJson['somcnote'] = "";
						entityJson['sowmnote'] = "";
						entityJson['sompnote'] = "";

						choose = $(this).find(".mfy_sonb_choose").text();
						switch (choose) {
							case "pc"://生館
								entityJson['sofodate'] = $(this).find(".mfy_sofodate_val").val();
								entityJson['sofokdate'] = $(this).find(".mfy_sofokdate_val").val();
								entityJson['soscstatus'] = $(this).find(".mfy_soscstatus_val").val();
								entityJson['soscnote'] = $(this).find(".mfy_soscnote_val").val();
								break
							case "mc"://物控
								entityJson['somcdate'] = $(this).find(".mfy_somcdate_val").val();
								entityJson['somcnote'] = $(this).find(".mfy_somcnote_val").val();
								break;
							case "wm"://倉儲
								entityJson['sowmnote'] = $(this).find(".mfy_sowmnote_val").val();
								break;
							case "pl"://製造
								entityJson['sompnote'] = $(this).find(".mfy_sompnote_val").val();
								break;
							case "br"://置亮
								entityJson['sysheader'] = $(this).find(".mfy_sobr_val").prop("checked");
								break;
						}
						entityJsons.push(entityJson);
					}
				});
				other.data.entityJsonForWebsocket = JSON.stringify(entityJsons);
			},

			//確認(needSend)
			confirmSend() {
				var entityJsons = [];//回傳一般資料
				var entityDetailJsons = [];//回傳細節資料
				var data = null;
				var type = "PUT";
				var action = "";
				var req_data = {};
				var searchPageSet = {};
				var choose = "";

				//確認選取
				$('#search_c_modify tbody .mfy_datas').each(function () {
					var entityJso = [];
					var regEx = /^\d{4}-\d{2}-\d{2}$/;
					if ($(this).attr("id") != "") {
						console.log($(this).attr("id"));
						entityJson = JSON.parse(JSON.stringify(other.data.entityFormatJson));//格式
						entityJson['soid'] = parseInt($(this).attr("id"));
						entityJson['sonb'] = $(this).find("mfy_sonb_val").val();
						data = {};
						choose = $(this).find(".mfy_sonb_choose").text();
						switch (choose) {
							case "pc"://生館
								entityJson['sofodate'] = $(this).find(".mfy_sofodate_val").val();
								entityJson['sofokdate'] = $(this).find(".mfy_sofokdate_val").val();
								entityJson['soscstatus'] = $(this).find(".mfy_soscstatus_val").val();
								entityJson['soscnote'] = $(this).find(".mfy_soscnote_val").val();
								action = "S1";
								break
							case "mc"://物控
								var somcdate = $(this).find(".mfy_somcdate_val").val()
								if (somcdate.match(regEx) || somcdate == '') {
									entityJson['somcdate'] = $(this).find(".mfy_somcdate_val").val();
									entityJson['somcnote'] = $(this).find(".mfy_somcnote_val").val();
									action = "S2";
								} else {
									entityJsons = [];//清除
									return false;  // Invalid format
								}
								break;
							case "wm"://倉儲
								entityJson['sowmnote'] = $(this).find(".mfy_sowmnote_val").val();
								action = "S3";
								break;
							case "pl"://製造
								entityJson['sompnote'] = $(this).find(".mfy_sompnote_val").val();
								action = "S4";
								break;
							case "br"://置亮
								entityJson['sysheader'] = $(this).find(".mfy_sobr_val").prop("checked");
								needSend = false;
								break;
						}
						entityJsons.push(entityJson);
					}
				});
				//傳送....
				console.log(entityJsons);
				data = {};
				data['entityJson'] = JSON.stringify(entityJsons);
				data['entityDetailJson'] = JSON.stringify('{}');
				if (data != null && entityJsons.length > 0) {
					//包裝
					data['callBackFunction'] = "other_modify";
					req_data['data'] = data;
					req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil." + action;//AC/AD....
					req_data['type'] = type;//POST/PUT/DELETE...
					other.data.entityJsonForWebsocket = data['entityJson'];
					//needSend(false=不一般傳送)
					if (choose == "br") {
						//由Websocket 傳送(取消置亮)
						other.methods.websocketSendMessage("sendAllClearShow");
					} else {
						main.methods.ajaxSend(req_data, true);
					}
				}
				return false;
			},
			//查詢
			searchSend(batch) {
				var entityJson = other.data.entityFormatJson;//格式
				var data = {};
				var req_data = {};
				var searchPageSet = {};

				//查詢
				$("#searchItem .searchVal").each(function (index) {
					//console.log(index+" : "+$(this).attr("id")+" : "+$(this).val());
					if ($(this).hasClass('datetimepicker_date') && $(this).val() != "") {
						entityJson[$(this).attr("id")] = new Date($(this).val()).getTime();
					} else {
						entityJson[$(this).attr("id")] = $(this).val() == "" ? null : $(this).val();
					}
				});
				data['entityJson'] = JSON.stringify(entityJson);
				//換頁
				searchPageSet['total'] = other.data.searchPageSet.total;//批次數量
				searchPageSet['batch'] = batch;//第幾批次
				data['searchPageSet'] = JSON.stringify(searchPageSet);
				data['callBackFunction'] = "other_search";
				//包裝
				req_data['data'] = data;
				req_data['url'] = $('#nav_functional_unit').attr('title') + ".basil.AR";
				req_data['type'] = "POST";
				main.methods.ajaxSend(req_data, true);
				//時間格式
				other.methods.datetimepickerDate();
			},
			//==========================回傳資料==========================
			//修改後回傳
			otherModifyReturn() {
				//$("#btn_markCancel").trigger('click');
				//other.methods.searchSend(0);
				other.methods.websocketSendMessage("sendAllData");
			},
			//查詢回傳
			otherReturn() {
				console.log("searchReturn");
				//Step4.分頁歸位
				if (main.resq_data['entityJson'].length > 0) {
					var searchPageSet = JSON.parse(main.resq_data['searchPageSet']);
					other.data.searchPageSet.total = searchPageSet['total'];
					other.data.searchPageSet.batch = searchPageSet['batch'];
					other.data.searchPageSet.pageNew = 1; //單前頁碼(1-50)
					other.data.marks = {};//有選取的IKeyGKey
					//Step5.帶入資料
					if (main.resq_data['entityJson'] != "") {
						other.data.searchPageSet.entityJsons = JSON.parse(main.resq_data['entityJson']);
						console.log(JSON.parse(main.resq_data['entityJson']));
						other.methods.otherReLoad(null);
					}
				}
			},
			//==========================資料載入==========================
			otherReLoad(actionType) {
				//還原
				$(".valTbodyTrYW_Re").remove();
				$('.valTbodytd').text("");
				$('.exTbodyTh input').attr("disabled", "disabled");
				$('.exTbodyTh input').attr("title", "IKey_GKey");
				//$('.exTbodyTh input').prop("checked", false);
				$("#search_cr td").removeClass('table-success');
				$("#search_cr tr").removeClass('table-success');
				$("#search_cr tr").removeClass("table-danger");

				//版面預設
				if ($('#search_dcr_open').hasClass('show')) {
					$('#search_dcr .btn-outline-white').trigger('click');
				}
				if (!$('#search_cr_open').hasClass('show')) {
					$('#search_cr .btn-outline-white').trigger('click');
				}
				//Step6.帶入資料
				var marks = other.data.marks;
				var entityJsons = other.data.searchPageSet.entityJsons;
				var entityIKey = other.data.entityIKey;
				var entityGKey = other.data.entityGKey;
				var entityDateTime = other.data.entityDateTime;
				var pageSize = other.data.searchPageSet.pageSize;//每頁數量(1-20)
				var pageNew = other.data.searchPageSet.pageNew - 1;//單前頁碼(1-50)
				var pageSN = pageSize * pageNew;//目前分頁->資料戳記
				//週期插入
				var yyW00 = "";//週期
				var yyW00LastClass = "";//上週期位置 
				var yyW00Qty = 0;//週期數量
				//如果不夠筆數?
				if (other.data.valTbodyTr < entityJsons.length) {
					var valTbodyTrAdd = (entityJsons.length - other.data.valTbodyTr);
					console.log("缺:" + valTbodyTrAdd);//要從n+1起算
					for (var b = (other.data.valTbodyTr + 1); b <= entityJsons.length; b++) {
						var exTbodyTr = $('.exTbodyTr').clone();
						exTbodyTr.removeClass('exTbodyTr');
						exTbodyTr.addClass('valTbodyTr_' + b);
						exTbodyTr.find('input').attr("alt", "row_" + b);
						$('.exTbodyTr').before(exTbodyTr);
					}
					other.data.valTbodyTr += valTbodyTrAdd;
				}
				//Step3.查詢內容-格式(資料筆數)
				for (var x = 0; x < entityJsons.length; x++) {
					var valTrNb = x + 1;
					var entity = entityJsons[x];//((目前頁碼-1)*每頁數量)+x
					var iKey = "";
					var gKey = "";
					//每個欄位
					Object.keys(entity).forEach(function (k) {
						//欄位計數
						$('.valTbodyTr_' + valTrNb + ' th input').removeAttr("disabled");
						//是否IKEY?
						if (entityIKey == k) {iKey = entity[k];}
						//是否GKEY?
						if (entityGKey == k) {gKey = entity[k];}
						//是否時間格式?
						if (entityDateTime.indexOf(k) >= 0) {
							var dF = new Date(entity[k]);
							var dateF = dF.getFullYear() + "-";
							dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
							dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
							dateF += (dF.getHours() < 10 ? "0" + dF.getHours() : dF.getHours()) + ":";
							dateF += (dF.getMinutes() < 10 ? "0" + dF.getMinutes() : dF.getMinutes()) + ":";
							dateF += (dF.getSeconds() < 10 ? "0" + dF.getSeconds() : dF.getSeconds());
							$('.valTbodyTr_' + valTrNb + ' .' + k).text(dateF);
						} else {
							//生管_物控_製造_倉庫
							if (k == "soscnote" || k == "somcnote" || k == "sowmnote" || k == "sompnote") {
								var note = JSON.parse(entity[k]);
								var notes = '<div class="noteShow" style="overflow: hidden;height: 80px;">';
								var noteIns = "";
								var first = true;
								var mb_1 = "";
								note.forEach(function (one) {
									mb_1 = (first ? "" : "mb-1"); first = false;//間格用
									var content = one['content'];
									content = content.replaceAll('\n', '</br>');
									noteIns = '<div class="row m-0 border border-secondary ' + mb_1 + '">' +
										'<div class="col-12 m-0 p-0 row needbr ">' +
										one['user'] + ' ／ ' + one['date'] +
										'</div>' +
										'<div class="col-12 p-1 pb-0 text-start border border-secondary notes needbr" ' +
										'style="word-break:break-word;white-space:normal;height: 100%;min-height:60px;">' + content + '</div>' +
										'</div>' + noteIns;
								});
								notes += noteIns + '</div>';

								$('.valTbodyTr_' + valTrNb + ' .' + k).html(notes);
								$('.valTbodyTr_' + valTrNb + ' .' + k).find(".row").first().removeClass("border-secondary").addClass("border-warning");
							} else if (k == "sostatus") {
								//製令單狀態
								var sostatus = "";
								switch (entity[k]) {
									case "1":
										sostatus = "未生產";
										break;
									case "2":
										sostatus = "已發料";
										break;
									case "3":
										sostatus = "生產中";
										break;
								}
								$('.valTbodyTr_' + valTrNb + ' .' + k).text(sostatus);
							} else if (k == "soscstatus") {
								//生管狀態
								var soscstatus = "";
								switch (entity[k]) {
									case 1:
										soscstatus = "已發料";
										break;
									case 2:
										soscstatus = "部分缺料";
										break;
									case 3:
										soscstatus = "備料中";
										break;
									case 4:
										soscstatus = "未生產";
										break;
									case 5:
										soscstatus = "待通知打件";
										break;
								}
								$('.valTbodyTr_' + valTrNb + ' .' + k).text(soscstatus);
								$('.valTbodyTr_' + valTrNb + ' .' + k).attr("title", entity[k]);

							} else if (k == "somcstatus") {//物控狀態
								var somcstatus = "";
								switch (entity[k]) {
									case 0:
										somcstatus = "未確認";
										break;
									case 1:
										somcstatus = "未齊料";
										break;
									case 2:
										somcstatus = "已齊料";
										break;
								}
								$('.valTbodyTr_' + valTrNb + ' .' + k).text(somcstatus);
							} else if (k == "sonote") {//製令單備註
								$('.valTbodyTr_' + valTrNb + ' .' + k).html('<div class="text-start" style="height:80px;white-space: normal;line-height: 16px; font-size:14px;">' + entity[k] + '</div>');

							} else {
								//一般文字
								$('.valTbodyTr_' + valTrNb + ' .' + k).text(entity[k]);
							}
						}
						//marks標記?
						$('.valTbodyTr_' + valTrNb + ' input').attr("title", iKey + "_" + gKey);
						//marks帶入
						for (var m = 0; m < marks.length; m++) {
							if (marks[m].Ikey_Gkey == iKey + "_" + gKey) {
								$('.valTbodyTr_' + valTrNb + ' input').prop("checked", true);
								break;
							}
						}
					});
					//顯示筆數
					$('.valTbodyTr_' + valTrNb).removeClass("d-none");
					//========指定週期欄位->每周數量========
					if (yyW00 != entity["soywdate"]) {
						//Step1.上次位置?
						if ($(yyW00LastClass).length >= 1) {
							$(yyW00LastClass).find(".TbodyThYW").text("年-週期:" + yyW00 + "  周-未產總數:" + yyW00Qty);
							yyW00Qty = 0;
						}
						//Step2.不同週期時?
						yyW00 = entity["soywdate"];
						//複製						
						var exTbodyTrYW = $('.exTbodyTrYW').clone();
						exTbodyTrYW.removeClass("exTbodyTrYW");
						//exTbodyTrYW.removeClass("d-none");
						exTbodyTrYW.addClass("valTbodyTrYW_" + yyW00);
						exTbodyTrYW.addClass("valTbodyTrYW");
						exTbodyTrYW.addClass("valTbodyTrYW_Re");
						//Step3.登記
						yyW00LastClass = ".valTbodyTrYW_" + yyW00;
						yyW00Qty += (entity["sorqty"] - entity["sookqty"]);
						console.log("年-週期:" + yyW00 + " / 周-未產總數:" + yyW00Qty);
						//Step4.插入
						//exTbodyTrYW.insertBefore('.valTbodyTr_' + valTrNb);
						//Step5.最後一筆?
						if ((pageSN + x) == entityJsons.length - 1) {
							$(yyW00LastClass).find(".TbodyThYW").text("年-週期:" + yyW00 + "  周-未產總數:" + yyW00Qty);
						}
					} else {
						//同一週期時
						yyW00Qty += (entity["sorqty"] - entity["sookqty"]);
						//Step5.最後一筆?
						if ((pageSN + x) == entityJsons.length - 1) {
							$(yyW00LastClass).find(".TbodyThYW").text("年-週期:" + yyW00 + "  周-未產總數:" + yyW00Qty);
						}
					}

					//========有改過的資料========
					var tagEntity = JSON.parse(entity['tag']);
					Object.keys(tagEntity).forEach(function (t) {
						if (tagEntity[t] != "") {
							if (t == "all") {
								//全部都是新的
								$('.valTbodyTr_' + valTrNb).addClass("table-success");
							}
							$('.valTbodyTr_' + valTrNb + " ." + t).addClass("table-success");
						}

					});

					//========有上鎖/解鎖的資料========
					if (tagEntity.locked) {
						$('.valTbodyTr_' + valTrNb).addClass("table-danger");
					} else {
						$('.valTbodyTr_' + valTrNb).removeClass("table-danger");
					}
				}
			},
			//==========================初始化==========================
			destroy() {
				//websocket離線
				var objson = {};
				objson.user = $("#menu_login_name").attr("alt");
				objson.action = "leave";
				objson.update = "";
				var objstring = JSON.stringify(objson);
				other.data.websocket.send(objstring);
				//銷毀
				$(".datetimepicker").remove();
				$(document).off("click", "#search_c #exthAll");
				$(document).off("click", "#search_c #btn_markCancel");
				$(document).off("change", "#search_c #search_cr_open .exTbodyTh input");
				$(document).off("click", "#search_c #btn_pc");
				$(document).off("click", "#search_c #btn_mc");
				$(document).off("click", "#search_c #btn_wm");
				$(document).off("click", "#search_c #btn_pl");
				$(document).off("click", "#search_c #btn_br");
				$(document).off("click", "#search_c #btn_clearAll");
				$(document).off("click", "#search_c #btn_send");
				$(document).off("keyup", "#searchItem input");
				$(document).off("mouseenter mouseleave", ".noteShow");
				$(document).off("click", "#search_c #btn_confirm");
				$(document).off("click", "#search_c #btn_exp_excel");
				$(document).off("change", "#btn_inp_excel .form-control-file");
				$(document).off("click", "#btn_inp_excel_ex");

				console.log("other.html(destroy)");
			},
		},
	};
</script>