<style>
#print_l {
	min-height: calc(100vh - 120px);
}

#print_c .wlr {
	writing-mode: vertical-lr;
	width: 20px;
}

#print_c .title_color {
	background-color: #cfe2ff;
}
</style>
<div id="print_c" class="row p-1 m-0">
	<!-- 控制面板 -->
	<div id="print_c_controller" class="col-12 p-1 ">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-primary text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#print_c_controller_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="print_c_controller_open" class="row m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-primary text-white"> Console </b>
			<div
				class="col border border-primary row m-0 p-0 shadow-sm justify-content-between">
				<div class="col-6 col-lg-4 p-1">
					<div class=" border border-secondary rounded">
						<div class="title_color fw-bolder rounded-top">Print</div>
						<div class="row m-0">
							<button id="btn_print" type="button"
								onclick="print.methods.printLabel()"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-success">
								<b>Print Label<br>(AR)
								</b>
							</button>
							<button id="btn_print_header" type="button"
								onclick="print.methods.printHeader()"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-primary">
								<b>Print<br>Header()
								</b>
							</button>
							<button id="btn_print_clearAll" type="button"
								class="lh-1 col p-1 m-1  btn btn-sm btn-outline-warning">
								<b>Clear<br>all()
								</b>
							</button>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
	<div class="col-12 p-1 ">
		<div
			class="col-12 p-0 m-0 lh-1 text-start rounded-top bg-info text-white">
			<i class="btn btn-outline-white p-0 pr-1 pl-1 bi bi-dash-square"
				data-bs-toggle="collapse" data-bs-target="#print_c_content_open"
				aria-expanded="false" style="width: 22px; height: 24px;"></i>
		</div>
		<div id="print_c_content_open" class="row p-0 m-0 collapse show">
			<b class="p-0 m-0 lh-1 wlr bg-info text-white"> Console </b>
			<div
				class="col border border-primary row m-0 p-0 shadow-sm justify-content-between"
				style="max-height: calc(100vh - 260px); overflow: auto;">
				<div id="print_l"
					class="col-6 border border-info rounded-top p-1 bg-white shadow-sm">
					<div id="printContent">
						<div class="noprint" style="height: 20px">(====vvv 範例
							vvv====)</div>
						<div id="print_ex"
							class="noprint border border-info mt-1 mb-1 text-start"
							style="page-break-after: always; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: auto;">
							<div style="border: 1px solid gainsboro;">
								<div
									style="display: inline-block; width: 315px; font-stretch: condensed;">
									<!-- 物料名 
									<div class="">
										<b>物料名：</b><font class="pr_bslpname">10K_1%/0402_THERMISTOR</font>
									</div>-->
									<!-- 單據 -->
									<div class="">
										<font style="font-size: 17px;" class="pr_bslnb">0001</font><b
											class="pr_type">／領:</b> <font class="pr_bslclass_bslsn">A551-230829006</font><b>：</b>
										<font class="pr_sysnote">備註</font>
									</div>
									<!-- 單據-來源 -->
									<div class="">
										<b>製:</b> <font class="pr_bslfromcommand">[A521-230906001*90-316-T11RD01*1]
										</font>
									</div>
									<!-- 物料號 / 數量  -->
									<div class="" style="font-size: 15px">
										<b>料:</b> <font class="pr_bslpnumber">01-255-610073</font>／<b>名:</b>
										<font class="pr_bslpname">北泰_7" TP_FPG</font>
									</div>
								</div>
								<div style="display: inline-block; top: 20px" class="pr_qrcode"></div>
								<!-- 倉儲-位 -->
								<div class="" style="font-size: 15px; font-stretch: condensed;">
									<b>量:</b> <font class="pr_bslpnqty">500</font><b
										class="pr_kind">／源:</b> <font class="pr_bslfromwho" alt="">[A0002_原物料倉]</font>／<b>責:</b>
									<font class="pr_user">Nobody</font>
								</div>
							</div>
						</div>
						<div id="print_start" class="noprint">(====vvv 正式 vvv====)</div>

					</div>
				</div>
				<div id="print_m"
					class="col-6 border border-info rounded-top p-1 bg-white shadow-sm">
					<div id="printContent_m">
						<div class="noprint" style="height: 20px">(====vvv 範例
							vvv====)</div>
						<div id="print_m_ex"
							class="noprint border border-info mt-1 mb-1 text-start"
							style="page-break-after: always; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: auto;">
							<table
								style="border: 1px solid rgb(0, 0, 0); width: 100%; font-size: 50px;">
								<tbody>
									<tr style="height: 100px;">
										<td
											style="border: 1px solid rgb(0, 0, 0); font-size: 25px; vertical-align: top; width: 22.5%;">
											預計(發料日):
											<div class="pr_wasedate"></div>
										</td>
										<td
											style="border: 1px solid rgb(0, 0, 0); font-size: 25px; vertical-align: top; width: 30%;">
											優先順序:</td>
										<td
											style="border: 1px solid rgb(0, 0, 0); font-size: 25px; vertical-align: top; width: 25%;">
											標記集結:</td>
										<td
											style="border: 1px solid rgb(0, 0, 0); font-size: 25px; vertical-align: top; width: 22.5%;">
											預計(出貨日):
											<div class="pr_wassdate"></div>
										</td>
									</tr>
									<tr style="border: 1px solid rgb(0, 0, 0);">
										<td>工單:</td>
										<td class="pr_bslfromcommand" colspan="2">A577-123456789</td>
										<td class="pr_bslfromcommand_qrcode">QRcode</td>
									</tr>
									<tr style="border: 1px solid rgb(0, 0, 0);">
										<td>品號:</td>
										<td class="pr_bslfromcommand_sn" colspan="3">90-123-123456</td>
										<td class=""></td>
									</tr>
									<tr style="border: 1px solid rgb(0, 0, 0);">
										<td>套數:</td>
										<td class="pr_bslfromcommand_qty" style="text-align: center">100</td>
										<td>客戶:</td>
										<td class="pr_bslfromcommand_client"
											style="text-align: center"></td>
									</tr>
									<tr style="height: 100px; font-size: 30px;">
										<td>樓層<br>&備註:
										</td>
										<td colspan="3" class="pr_syshnote"
											style="white-space: normal; word-break: break-all;"></td>
										<td></td>
									</tr>
									<tr style="border: 1px solid rgb(0, 0, 0);">
										<td>料單:</td>
										<td class="pr_bslclass_bslsn" colspan="2">A577-123456789</td>
										<td class="pr_bslclass_bslsn_qrcode">QRcode</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div id="print_m_start" class="noprint">(====vvv 正式 vvv====)</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		//宣告
		//console.log("print.html(init)");
		window.realPrint = window.print;
		print = {
			//資料
			data: {
				cells: {},//①②③④⑤⑥⑦⑧⑨⑩
				cellNbs: ["①", "②", "③", "④", "⑤", "⑥", "⑦", "⑧", "⑨", "⑩"]
			},
			//方法
			methods: {
				create() {
					//Step1.初始化
					console.log("print.html(created)");
					//監聽-建立
					$(document).off("click", "#print_c #btn_print_clearAll");
					$(document).on("click", "#print_c #btn_print_clearAll", function (event) {
						console.log("btn_print_clearAll");
						$(".printList").remove();
					});
				},
				printLabel() {
					//標籤
					//$('#print_qrcode').qrcode({width: 60,height: 60,text: "01-255-610073"});
					var divContents = $("#printContent").html();
					var printWindow = window.open('', '', 'height=800,width=500');
					//新視窗處理
					printWindow.document.write('<html><head><title>DIV Contents</title>');
					printWindow.document.write('<style> @media print{.noprint{display:none;}}</style>');
					printWindow.document.write('</head><body style="font-size: 12px; margin: 1;line-height: 17px;font-family: sans-serif;">');
					printWindow.document.write(divContents);
					printWindow.document.write('</body></html>');
					//查詢
					$(".printList").each(function (index) {
						if (this.id != "") {
							var id = this.id;
							var pr_bslpnumber = $(this).find(".pr_bslpnumber").text();//物料號
							var pr_bslfromwho = $(this).find(".pr_bslfromwho").attr("alt");//倉別
							$(printWindow.document).find('#' + id + ' .pr_qrcode').qrcode({width: 50, height: 50, text: pr_bslfromwho + "_" + pr_bslpnumber});
							$(printWindow.document).find('.printList').css("width", "370px");
							console.log(this.id + ":" + pr_bslfromwho + "_" + pr_bslpnumber);
						}
					});
					printWindow.document.close();
					printWindow.print();
				},
				printHeader() {
					//供給單
					var divContents = $("#printContent_m").html();
					var printWindow = window.open('', '', 'height=800,width=800');
					//新視窗處理
					printWindow.document.write('<html><head><title>DIV Contents</title>');
					printWindow.document.write('<style> @media print{.noprint{display:none;}}</style>');
					printWindow.document.write('</head><body>');
					printWindow.document.write(divContents);
					printWindow.document.write('</body></html>');
					//查詢
					$(".printList").each(function (index) {
						if (this.id != "") {
							var id = this.id;
							var pr_bslclass_bslsn = $(this).find(".pr_bslclass_bslsn").text();//領料單
							var pr_bslfromcommand = $(this).find(".pr_bslfromcommand").text();//製令單
							$(printWindow.document).find('#' + id + ' .pr_bslclass_bslsn_qrcode').qrcode({width: 50, height: 50, text: pr_bslclass_bslsn});
							$(printWindow.document).find('#' + id + ' .pr_bslfromcommand_qrcode').qrcode({width: 50, height: 50, text: pr_bslfromcommand});

							$(printWindow.document).find('.printList').css("width", "100%");
							console.log(this.id + ":" + pr_bslclass_bslsn);
						}
					});

					printWindow.document.close();
					printWindow.print();

				},
				printPrepare(dataHeader, dataBody, entityIKey, entityGKey) {
					//合併備料?
					print.data.cells = {};
					if (dataHeader.length > 1 && dataHeader.length <= 10) {
						dataHeader.forEach(function (hds, index) {
							//標記代號
							print.data.cells[hds.gid] = print.data.cellNbs[index];
						});
					} else if (dataHeader.length > 10) {
						console.warn("cellNbs 中的元素不足，無法為所有 dataHeader 匹配值");
						return false;
					}

					//打印
					$('#print_title').trigger('click');
					$(".printList").remove();
					console.log(dataHeader);
					console.log(dataBody);
					//排序整理
					var sortJson = {};
					Object.keys(dataBody).forEach(function (k) {
						sortJson[dataBody[k]['wasmuser'] + dataBody[k]['wasfromwho']+ dataBody[k]['waspnumber'] + dataBody[k]['id']] = dataBody[k];
					});
					sortJson = main.methods.orderedSort(sortJson);

					//一般
					var pr_bslclass_bslsn = {};
					Object.keys(sortJson).forEach(function (k) {
						console.log(sortJson[k]);
						var h = sortJson[k];
						var key = h.id + '_' + h.waspnumber;
						var print_ex = $('#print_ex').clone();
						print_ex.attr("id", key);
						print_ex.removeClass("noprint");
						print_ex.addClass("printList");
						print_ex.find(".pr_bslpnumber").text(h.waspnumber);//物料號
						print_ex.find(".pr_bslpnqty").text(h.waspnqty);//數量
						//	print_ex.find(".pr_bslpname").text(h.waspname);//物料名稱
						let bslclass_bslsn = h.id.split("-")[0] + "-" + h.id.split("-")[1];
						print_ex.find(".pr_bslclass_bslsn").text(bslclass_bslsn);//單據號
						print_ex.find(".pr_bslnb").text(h.id.split("-")[2]);//單據序
						//區分①②③④
						let pr_bslfrom = h.wasfromcommand.replaceAll("*", "＊").replaceAll("[", "").replaceAll("]", "");
						let pr_nb = (print.data.cells[bslclass_bslsn] == null) ? "" : print.data.cells[bslclass_bslsn] + " : ";
						print_ex.find(".pr_bslfromcommand").text(pr_nb + pr_bslfrom);//單據來源

						//整理文字(可能是來源 或對象)
						//[A0002_原物料倉_2F-BH-04-02]
						var pr_bslfromwho = h.wasfromwho.replaceAll("[", "").replaceAll("]", "");
						var pr_bslfromwho_alt = pr_bslfromwho.split("_")[0];
						pr_bslfromwho = pr_bslfromwho.split("_")[1] + "_" + pr_bslfromwho.split("_")[2];

						//入料類型:須修正
						if (h.wastype == "入料類") {
							pr_bslfromwho = h.wastowho.replaceAll("[", "").replaceAll("]", "");
							pr_bslfromwho_alt = pr_bslfromwho.split("_")[0];
							pr_bslfromwho = pr_bslfromwho.split("_")[1] + "_" + pr_bslfromwho.split("_")[2];
							print_ex.find(".pr_kind").text("／象:");
							print_ex.find(".pr_type").text("／退:");
							if (bslclass_bslsn.includes("A581")) {
						        // A581
								print_ex.find(".pr_type").text("／生:");
						    }
							
						}

						print_ex.find(".pr_bslfromwho").text(pr_bslfromwho);//來源
						print_ex.find(".pr_bslfromwho").attr("alt", pr_bslfromwho_alt);//來源(倉別)
						print_ex.find(".pr_bslpname").text(h.waspname);//品名

						print_ex.find(".pr_user").text(h.wasmuser);//負責人
						print_ex.find(".pr_sysnote").text(h.sysnote);//備註
						$('#print_l #print_start').after(print_ex);

						//配給A4
						if (pr_bslclass_bslsn[print_ex.find(".pr_bslclass_bslsn").text()] == null ) {
							pr_bslclass_bslsn[print_ex.find(".pr_bslclass_bslsn").text()] = true;
							var print_m_ex = $('#print_m_ex').clone();
							var pr_bslfromcommand = pr_bslfrom.split("＊");
							print_m_ex.attr("id", print_ex.find(".pr_bslclass_bslsn").text() + "_1");
							print_m_ex.removeClass("noprint");
							print_m_ex.addClass("printList");
							print_m_ex.find(".pr_bslclass_bslsn").text(print_ex.find(".pr_bslclass_bslsn").text());//領料單
							print_m_ex.find(".pr_bslfromcommand").text(pr_bslfromcommand[0].replaceAll("_生產入庫單",""));//製令單(特定單據會有需要去除)
							print_m_ex.find(".pr_bslfromcommand_sn").text(pr_bslfromcommand[1]);//品號
							print_m_ex.find(".pr_bslfromcommand_qty").text(pr_bslfromcommand[2]);//數量 
							print_m_ex.find(".pr_cell").text(print.data.cells[print_ex.find(".pr_bslclass_bslsn").text()]);//標記①②③④-領料單
							if (bslclass_bslsn.includes("A581")) {
						        // A581
								print_m_ex.find(".pr_bslfromcommand_sn").text(h.waspnumber);//品號
								print_m_ex.find(".pr_bslfromcommand_qty").text(h.waspnqty);//數量 
						    }
							 
							dataHeader.forEach(function (hds) {
								console.log(hds);
								if (hds.gid == print_ex.find(".pr_bslclass_bslsn").text()) {
									print_m_ex.find(".pr_syshnote").text(hds.syshnote);//樓層備註
									var dF = new Date(hds.wasedate);
									var dateF = dF.getFullYear() + "-";
									dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
									dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
									print_m_ex.find(".pr_wasedate").text(dateF);//預計開工

									dF = new Date(hds.wassdate);
									dateF = dF.getFullYear() + "-";
									dateF += ((dF.getMonth() + 1) < 10 ? "0" + (dF.getMonth() + 1) : (dF.getMonth() + 1)) + "-";
									dateF += (dF.getDate() < 10 ? "0" + (dF.getDate()) : dF.getDate()) + " ";
									print_m_ex.find(".pr_wassdate").text(dateF);//預計出貨
								}
							});

							print_m_ex.find(".pr_bslfromcommand_qrcode").text("");//
							print_m_ex.find(".pr_bslclass_bslsn_qrcode").text("");//
							print_m_ex.css("paddingTop", "25px");


							$('#print_m #print_m_start').after(print_m_ex);
							//每張A4 列印兩筆
							var print_m_ex2 = print_m_ex.clone();
							print_m_ex2.attr("id", print_ex.find(".pr_bslclass_bslsn").text() + "_2");
							print_m_ex2.removeClass("noprint");
							print_m_ex2.css("pageBreakAfter", "");
							$('#print_m #print_m_start').after(print_m_ex2);
						}
					});
					//細節(區分)
					var print_ex = $('#print_ex').clone();
					print_ex.attr("id", "");
					print_ex.removeClass("noprint");
					print_ex.addClass("printList");
					print_ex.css("height", "94px");
					print_ex.html("===區分線/備註事項===");
					$('#print_l #print_start').after(print_ex);
				},
				destroy() {
					//銷毀
					$(document).off("click", "#print_c #btn_print_clearAll");
					console.log("print.html(destroy)");

				},
			},
		};
	</script>